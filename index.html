<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>× ×™×”×•×œ ×ª×™×§×™× ××©×¤×˜×™×™×</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;× ×™×”×•×œ ×ª×™×§×™× ××©×¤×˜×™×™×&quot;,&quot;short_name&quot;:&quot;××©×¨×“ ×¢×•×´×“&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%230d1018&quot;,&quot;theme_color&quot;:&quot;%23c9a84c&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;https://raw.githubusercontent.com/twitter/twemoji/master/assets/72x72/2696.png&quot;,&quot;sizes&quot;:&quot;72x72&quot;,&quot;type&quot;:&quot;image/png&quot;}]}">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="××©×¨×“ ×¢×•×´×“">
<meta name="theme-color" content="#3b82f6">
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f2ede4;
  --surface: #fdf9f3;
  --surface2: #ebe5d8;
  --border: #d6cdb8;
  --accent: #1a3a6e;
  --accent2: #1e4fa0;
  --text: #1a1a2e;
  --text2: #3d4a6b;
  --text3: #8a8fa8;
  --danger: #b83040;
  --success: #1e6e40;
  --info: #1a4a8a;
  --warn: #a05010;
  --sidebar-w: 230px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;}
body{
  font-family:'Heebo',sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  font-size:14px;
  overflow:hidden;
  height:100vh;
}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
#sidebar{
  width:var(--sidebar-w);
  background:#071223;
  border-left:1px solid #050f1e;
  display:flex;flex-direction:column;
  height:100vh;position:fixed;right:0;top:0;z-index:100;
  transition:transform .25s ease;
}
.logo{padding:22px 20px 18px;border-bottom:1px solid rgba(255,255,255,.08);}
.logo-mark{font-size:22px;margin-bottom:4px;}
.logo-title{font-size:12px;font-weight:800;color:#60a5fa;letter-spacing:.12em;text-transform:uppercase;}
.logo-sub{font-size:11px;color:rgba(255,255,255,.35);margin-top:2px;}
.nav{flex:1;padding:10px 0;overflow-y:auto;}
.nav-section{padding:10px 18px 4px;font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:.12em;text-transform:uppercase;}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 18px;cursor:pointer;
  color:rgba(255,255,255,.55);font-size:13px;font-weight:500;
  transition:all .15s;position:relative;
}
.nav-item:hover{background:rgba(255,255,255,.07);color:rgba(255,255,255,.9);}
.nav-item.active{background:rgba(201,168,76,.18);color:#c9a84c;}
.nav-item.active::before{
  content:'';position:absolute;right:0;top:4px;bottom:4px;
  width:3px;background:#c9a84c;border-radius:2px 0 0 2px;
}
.nav-icon{font-size:15px;width:20px;text-align:center;}
.nbadge{
  margin-right:auto;background:#b83a4a;color:#fff;
  font-size:10px;font-weight:700;border-radius:10px;
  padding:1px 6px;min-width:18px;text-align:center;
}
.sidebar-footer{
  padding:14px 16px;border-top:1px solid rgba(255,255,255,.08);
  display:flex;gap:8px;
}
.sfbtn{
  flex:1;padding:8px 6px;border:1px solid rgba(255,255,255,.15);
  background:transparent;color:rgba(255,255,255,.5);border-radius:7px;
  cursor:pointer;font-size:11px;font-family:'Heebo',sans-serif;
  font-weight:600;transition:all .15s;
}
.sfbtn:hover{border-color:#c9a84c;color:#c9a84c;}

/* â”€â”€â”€ MAIN â”€â”€â”€ */
#main{
  margin-right:var(--sidebar-w);flex:1;
  height:100vh;overflow-y:auto;display:flex;flex-direction:column;
}
.topbar{
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:14px 28px;display:flex;align-items:center;
  justify-content:space-between;position:sticky;top:0;z-index:50;
}
.page-title{font-size:17px;font-weight:700;}
.page-sub{font-size:11px;color:var(--text3);margin-top:1px;}
.topbar-right{display:flex;align-items:center;gap:10px;}

/* â”€â”€â”€ MOBILE TOPBAR â”€â”€â”€ */
#mob-topbar{
  display:none;background:var(--surface);
  border-bottom:1px solid var(--border);
  padding:12px 16px;
  align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:50;
}
.mob-title{font-size:16px;font-weight:700;}
.mob-actions{display:flex;gap:8px;align-items:center;}

/* â”€â”€â”€ MOBILE NAV â”€â”€â”€ */
#mob-nav{
  display:none;position:fixed;bottom:0;left:0;right:0;
  background:var(--surface);border-top:1px solid var(--border);
  z-index:200;padding-bottom:var(--safe-bottom);
  box-shadow:0 -2px 12px rgba(0,0,0,.06);
}
.mob-nav-row{display:flex;justify-content:space-around;}
.mni{
  display:flex;flex-direction:column;align-items:center;
  gap:2px;padding:8px 6px;cursor:pointer;
  color:var(--text3);font-size:10px;font-weight:600;
  transition:all .15s;flex:1;position:relative;
}
.mni-icon{font-size:19px;}
.mni.active{color:var(--accent);}
.mni-badge{
  position:absolute;top:4px;right:calc(50% - 16px);
  background:var(--danger);color:#fff;
  font-size:9px;font-weight:700;border-radius:8px;padding:1px 4px;
}

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn{
  padding:8px 16px;border-radius:8px;border:none;cursor:pointer;
  font-family:'Heebo',sans-serif;font-weight:600;font-size:13px;
  transition:all .15s;display:inline-flex;align-items:center;gap:6px;
  white-space:nowrap;
}
.btn-primary{background:var(--accent);color:#000;}
.btn-primary:hover{background:var(--accent2);}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border);}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
.btn-success{background:rgba(76,175,130,.15);color:var(--success);border:1px solid rgba(76,175,130,.3);}
.btn-danger-soft{background:rgba(224,90,106,.12);color:var(--danger);border:1px solid rgba(224,90,106,.25);}
.btn-sm{padding:5px 11px;font-size:12px;}
.btn-xs{padding:3px 8px;font-size:11px;border-radius:5px;}

/* â”€â”€â”€ SEARCH â”€â”€â”€ */
.search-wrap{position:relative;}
.search-wrap input{
  padding:8px 34px 8px 12px;background:var(--bg);
  border:1px solid var(--border);border-radius:8px;
  color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;
  outline:none;transition:border .15s;width:260px;direction:rtl;
}
.search-wrap input:focus{border-color:var(--accent);}
.search-icon{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:14px;}

/* â”€â”€â”€ PAGE CONTENT â”€â”€â”€ */
.page-content{padding:24px 28px;}
.view{display:none;}
.view.active{display:block;}

/* â”€â”€â”€ STATS â”€â”€â”€ */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
.stat-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;padding:16px 18px;position:relative;overflow:hidden;
  box-shadow:0 1px 4px rgba(0,0,0,.04);
}
.stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.sc-gold::after{background:var(--accent);}
.sc-blue::after{background:var(--info);}
.sc-green::after{background:var(--success);}
.sc-warn::after{background:var(--warn);}
.stat-label{font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.08em;}
.stat-value{font-size:26px;font-weight:800;margin-top:6px;}
.sc-gold .stat-value{color:var(--accent);}
.sc-blue .stat-value{color:var(--info);}
.sc-green .stat-value{color:var(--success);}
.sc-warn .stat-value{color:var(--warn);}

/* â”€â”€â”€ CARD â”€â”€â”€ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.06);}
.card-title{font-size:14px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px;}

/* â”€â”€â”€ TABLE â”€â”€â”€ */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
th{
  text-align:right;padding:9px 14px;
  font-size:10px;font-weight:700;color:var(--text3);
  text-transform:uppercase;letter-spacing:.06em;
  border-bottom:1px solid var(--border);white-space:nowrap;
}
td{padding:11px 14px;border-bottom:1px solid rgba(37,45,69,.6);font-size:13px;vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.015);}

/* â”€â”€â”€ TAGS â”€â”€â”€ */
.tag{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap;}
.tag-active{background:rgba(76,175,130,.18);color:var(--success);}
.tag-closed{background:rgba(74,82,112,.3);color:var(--text3);}
.tag-pending{background:rgba(240,160,90,.18);color:var(--warn);}
.tag-urgent{background:rgba(224,90,106,.18);color:var(--danger);}
.tag-paid{background:rgba(76,175,130,.18);color:var(--success);}
.tag-unpaid{background:rgba(224,90,106,.18);color:var(--danger);}
.tag-partial{background:rgba(240,160,90,.18);color:var(--warn);}

/* â”€â”€â”€ ACTION ROW â”€â”€â”€ */
.action-row{display:flex;align-items:center;gap:10px;margin-bottom:18px;flex-wrap:wrap;}
.filter-select{
  padding:8px 12px;background:var(--bg);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-family:'Heebo',sans-serif;
  font-size:12px;outline:none;cursor:pointer;
}
.filter-select:focus{border-color:var(--accent);}

/* â”€â”€â”€ MODAL â”€â”€â”€ */
.modal-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.75);z-index:1000;
  align-items:center;justify-content:center;padding:16px;
}
.modal-overlay.open{display:flex;}
.modal{
  background:var(--surface);border:1px solid var(--border);
  border-radius:16px;padding:28px;
  width:560px;max-width:100%;max-height:92vh;overflow-y:auto;
  direction:rtl;
}
.modal-title{
  font-size:17px;font-weight:700;margin-bottom:20px;
  padding-bottom:14px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:8px;
}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-group{margin-bottom:14px;}
.form-full{grid-column:1/-1;}
label{display:block;font-size:11px;font-weight:700;color:var(--text2);margin-bottom:5px;letter-spacing:.04em;}
input,select,textarea{
  width:100%;padding:9px 12px;background:var(--bg);
  border:1px solid var(--border);border-radius:8px;
  color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;
  outline:none;transition:border .15s;direction:rtl;
}
input:focus,select:focus,textarea:focus{border-color:var(--accent);}
textarea{resize:vertical;min-height:75px;}
select option{background:var(--surface);}
.modal-actions{display:flex;gap:10px;margin-top:20px;}

/* â”€â”€â”€ CLIENT CARDS â”€â”€â”€ */
.client-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:14px;}
.client-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;padding:18px;cursor:pointer;
  transition:all .15s;
}
.client-card:hover{border-color:var(--accent);transform:translateY(-1px);}
.cc-name{font-size:15px;font-weight:700;}
.cc-id{font-size:11px;color:var(--text3);margin-top:2px;}
.cc-meta{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px 14px;font-size:12px;color:var(--text2);}
.cc-meta span{display:flex;align-items:center;gap:4px;}
.cc-actions{display:flex;gap:6px;margin-top:14px;border-top:1px solid var(--border);padding-top:12px;}

/* â”€â”€â”€ CLIENT PROFILE â”€â”€â”€ */
#view-client-profile .profile-header{
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;padding:24px;margin-bottom:20px;
  display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:16px;
}
.profile-avatar{
  width:52px;height:52px;border-radius:50%;
  background:rgba(201,168,76,.15);border:2px solid var(--accent);
  display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:700;color:var(--accent);flex-shrink:0;
}
.profile-info{flex:1;}
.profile-name{font-size:20px;font-weight:800;}
.profile-details{display:flex;flex-wrap:wrap;gap:10px 20px;margin-top:10px;font-size:13px;color:var(--text2);}
.profile-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:20px;}
.ptab{
  padding:10px 20px;cursor:pointer;font-size:13px;font-weight:600;
  color:var(--text3);border-bottom:2px solid transparent;
  transition:all .15s;
}
.ptab:hover{color:var(--text);}
.ptab.active{color:var(--accent);border-bottom-color:var(--accent);}
.ptab-content{display:none;}
.ptab-content.active{display:block;}

/* â”€â”€â”€ CALENDAR â”€â”€â”€ */
.cal-grid{
  display:grid;grid-template-columns:repeat(7,1fr);
  gap:1px;background:var(--border);border-radius:10px;overflow:hidden;
}
.cal-hdr{background:var(--surface2);padding:10px;text-align:center;font-size:11px;font-weight:700;color:var(--text3);}
.cal-day{background:var(--surface);min-height:82px;padding:7px;cursor:pointer;transition:background .1s;}
.cal-day:hover{background:var(--surface2);}
.cal-day.today{background:rgba(201,168,76,.07);}
.cal-day.other{opacity:.35;}
.cal-daynum{font-size:12px;font-weight:600;color:var(--text2);}
.cal-day.today .cal-daynum{color:var(--accent);font-weight:800;}
.cal-evt{
  background:var(--info);color:#fff;font-size:10px;
  padding:2px 5px;border-radius:3px;margin-top:3px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  cursor:pointer;
}
.cal-evt:hover{opacity:.85;}

/* â”€â”€â”€ TASK â”€â”€â”€ */
.task-done td{opacity:.45;text-decoration:line-through;}
.priority-high{color:var(--danger);font-weight:700;}
.priority-med{color:var(--warn);}
.priority-low{color:var(--text3);}

/* â”€â”€â”€ QUICK STATUS â”€â”€â”€ */
.qs-select{
  padding:4px 8px;background:transparent;border:1px solid var(--border);
  border-radius:6px;color:var(--text2);font-family:'Heebo',sans-serif;
  font-size:11px;cursor:pointer;outline:none;transition:border .15s;
}
.qs-select:focus{border-color:var(--accent);}

/* â”€â”€â”€ HINT â”€â”€â”€ */
.hint{
  background:rgba(90,156,245,.08);border:1px solid rgba(90,156,245,.25);
  border-radius:8px;padding:10px 14px;font-size:12px;color:var(--info);
  margin-top:10px;line-height:1.5;
}

/* â”€â”€â”€ BACKUP MODAL â”€â”€â”€ */
.bk-option{
  border:1px solid var(--border);border-radius:10px;
  padding:16px;margin-bottom:12px;cursor:pointer;transition:all .15s;
}
.bk-option:hover{border-color:var(--accent);}
.bk-option h4{font-size:14px;margin-bottom:4px;display:flex;align-items:center;gap:8px;}
.bk-option p{font-size:12px;color:var(--text3);line-height:1.5;}
.bk-btns{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;}
#gdrive-status{
  font-size:12px;padding:8px 12px;border-radius:6px;
  margin-top:8px;display:none;
}
#gdrive-status.ok{background:rgba(76,175,130,.15);color:var(--success);display:block;}
#gdrive-status.err{background:rgba(224,90,106,.15);color:var(--danger);display:block;}
#gdrive-status.info{background:rgba(90,156,245,.15);color:var(--info);display:block;}

/* â”€â”€â”€ MISC â”€â”€â”€ */
.empty{text-align:center;padding:52px 20px;color:var(--text3);}
.empty-icon{font-size:40px;margin-bottom:10px;opacity:.5;}
.empty-text{font-size:14px;}
.amount{font-weight:700;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}


/* â”€â”€â”€ CASE TAB CONTENT â”€â”€â”€ */
.ctab-content{display:none;}
.ctab-content.active{display:block;}
/* â”€â”€â”€ LOG ENTRY â”€â”€â”€ */
.log-entry{
  border-right:3px solid var(--accent);padding:12px 14px;margin-bottom:10px;
  background:#eef3fc;border-radius:0 8px 8px 0;position:relative;
  border:1px solid #c8d8f0;border-right:3px solid var(--accent2);
}
.log-entry-date{font-size:11px;color:var(--text3);margin-bottom:4px;font-weight:600;}
.log-entry-text{font-size:13px;line-height:1.6;white-space:pre-wrap;}
.log-entry-actions{display:flex;gap:5px;margin-top:7px;}
.log-entry-del{
  position:absolute;top:8px;left:8px;
  display:none;cursor:pointer;color:var(--text3);font-size:13px;
  background:var(--surface2);border:none;padding:2px 6px;border-radius:4px;
}
.log-entry:hover .log-entry-del{display:block;}
/* â”€â”€â”€ HEARING/MEETING ITEM â”€â”€â”€ */
.cev-item{
  display:flex;align-items:flex-start;gap:14px;
  padding:12px 0;border-bottom:1px solid var(--border);
}
.cev-item:last-child{border-bottom:none;}
.cev-date-block{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:6px 10px;text-align:center;min-width:52px;flex-shrink:0;
}
.cev-month{font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;}
.cev-day{font-size:20px;font-weight:800;color:var(--text);line-height:1.1;}
.cev-info{flex:1;}
.cev-title{font-size:13px;font-weight:700;}
.cev-sub{font-size:12px;color:var(--text2);margin-top:3px;}
.cev-past{opacity:.55;}
.cev-next .cev-date-block{border-color:var(--accent);background:rgba(201,168,76,.08);}
.cev-next .cev-day{color:var(--accent);}
.case-row-link{cursor:pointer;text-decoration:underline;text-underline-offset:2px;font-weight:600;}
.case-row-link:hover{color:var(--accent);}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(max-width:768px){
  :root{--sidebar-w:0px;}
  #sidebar{display:none;}
  #main{margin-right:0;padding-bottom:calc(62px + var(--safe-bottom));}
  .topbar{display:none;}
  #mob-topbar{display:flex;}
  #mob-nav{display:block;}
  .stats-row{grid-template-columns:1fr 1fr;gap:10px;}
  .page-content{padding:14px 16px;}
  #view-dashboard .dash-cols{grid-template-columns:1fr!important;}
  .form-row{grid-template-columns:1fr;}
  .modal{padding:20px;}
  .client-grid{grid-template-columns:1fr;}
  .cal-day{min-height:58px;padding:4px;}
  td,th{padding:8px 10px;}
  .search-wrap{display:none;}
  .profile-header{flex-direction:column;}
}

.search-result-item{padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;display:flex;align-items:center;gap:10px;}
.search-result-item:hover{background:var(--surface2);}
.search-result-item:last-child{border-bottom:none;}
.sri-type{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;min-width:50px;}
.sri-title{font-size:13px;font-weight:600;}
.sri-sub{font-size:11px;color:var(--text3);}

</style>
</head>
<body>

<!-- â•â•â•â• SIDEBAR â•â•â•â• -->
<nav id="sidebar">
  <div class="logo">
    <div class="logo-mark">âš–ï¸</div>
    <div class="logo-title">Legal Manager</div>
    <div class="logo-sub">× ×™×”×•×œ ×ª×™×§×™× ××©×¤×˜×™×™×</div>
  </div>
  <div class="nav">
    <div class="nav-section">×¨××©×™</div>
    <div class="nav-item active" data-view="dashboard">
      <span class="nav-icon">ğŸ“Š</span> ××¡×š ×”×‘×™×ª
    </div>
    <div class="nav-section">× ×™×”×•×œ</div>
    <div class="nav-item" data-view="clients">
      <span class="nav-icon">ğŸ‘¤</span> ×œ×§×•×—×•×ª
    </div>
    <div class="nav-item" data-view="cases">
      <span class="nav-icon">ğŸ“</span> ×ª×™×§×™×
    </div>
    <div class="nav-item" data-view="tasks">
      <span class="nav-icon">âœ…</span> ××©×™××•×ª
      <span class="nbadge" id="sb-badge">0</span>
    </div>
    <div class="nav-item" data-view="calendar">
      <span class="nav-icon">ğŸ“…</span> ×™×•××Ÿ
    </div>
    <div class="nav-item" data-view="charges">
      <span class="nav-icon">ğŸ’°</span> ×—×™×•×‘×™×
    </div>
    <div class="nav-item" data-view="search"><span class="nav-icon">ğŸ”</span> ×—×™×¤×•×©</div><div class="nav-section">×”×’×“×¨×•×ª</div>
    <div class="nav-item" onclick="openModal('settings')">
      <span class="nav-icon">âš™ï¸</span> ×¡×•×’×™ ×ª×™×§×™× ×•××—×™×¨×•×Ÿ
    </div>
  </div>
  <div class="sidebar-footer">
    <button class="sfbtn" onclick="openBackup()">â˜ï¸ ×’×™×‘×•×™</button>
    <button class="sfbtn" onclick="triggerImport()">ğŸ“¥ ×™×™×‘×•×</button>
    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
  </div>
</nav>

<!-- â•â•â•â• MAIN â•â•â•â• -->
<div id="main">

  <!-- Desktop Topbar -->
  <div class="topbar">
    <div>
      <div class="page-title" id="dt-title">××¡×š ×”×‘×™×ª</div>
      <div class="page-sub" id="dt-sub">×¡×§×™×¨×” ×›×œ×œ×™×ª</div>
    </div>
    <div class="topbar-right">
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search-input" placeholder="×—×™×¤×•×© ×œ×§×•×—, ×ª×™×§..." oninput="handleSearch(this.value)">
      </div>
    </div>
  </div>

  <!-- Mobile Topbar -->
  <div id="mob-topbar">
    <div class="mob-title" id="mob-title">××¡×š ×”×‘×™×ª</div>
    <div class="mob-actions">
      <button class="btn btn-ghost btn-sm" onclick="openBackup()">â˜ï¸</button>
      <button class="btn btn-primary btn-sm" id="mob-add" onclick="mobileAdd()" style="display:none">+ ×”×•×¡×£</button>
    </div>
  </div>

  <!-- â”€â”€ DASHBOARD â”€â”€ -->
  <div id="view-dashboard" class="view active page-content">
    <div class="stats-row">
      <div class="stat-card sc-gold">
        <div class="stat-label">×œ×§×•×—×•×ª</div>
        <div class="stat-value" id="s-clients">0</div>
      </div>
      <div class="stat-card sc-blue">
        <div class="stat-label">×ª×™×§×™× ×¤×ª×•×—×™×</div>
        <div class="stat-value" id="s-cases">0</div>
      </div>
      <div class="stat-card sc-warn">
        <div class="stat-label">××©×™××•×ª ×¤×ª×•×—×•×ª</div>
        <div class="stat-value" id="s-tasks">0</div>
      </div>
      <div class="stat-card sc-green">
        <div class="stat-label">×œ×’×‘×™×™×” (â‚ª)</div>
        <div class="stat-value" id="s-charges">0</div>
      </div>
    </div>
    <div class="dash-cols" style="display:grid;grid-template-columns:1fr 1fr;gap:18px;">
      <div class="card">
        <div class="card-title">â° ××©×™××•×ª ×¤×ª×•×—×•×ª</div>
        <div id="dash-tasks"></div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“… ××™×¨×•×¢×™× ×§×¨×•×‘×™×</div>
        <div id="dash-events"></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ CLIENTS â”€â”€ -->
  <div id="view-clients" class="view page-content">
    <div class="action-row">
      <button class="btn btn-primary" onclick="openNewClient()">+ ×œ×§×•×— ×—×“×©</button>
    </div>
    <div class="client-grid" id="clients-grid"></div>
  </div>

  <!-- â”€â”€ CLIENT PROFILE â”€â”€ -->
  <div id="view-client-profile" class="view page-content">
    <div class="action-row">
      <button class="btn btn-ghost" onclick="navTo('clients')">â† ×—×–×¨×” ×œ×œ×§×•×—×•×ª</button>
    </div>
    <div class="profile-header">
      <div style="display:flex;gap:16px;align-items:center;">
        <div class="profile-avatar" id="prof-avatar"></div>
        <div class="profile-info">
          <div class="profile-name" id="prof-name"></div>
          <div class="profile-details" id="prof-details"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-ghost btn-sm" id="prof-edit-btn">âœï¸ ×¢×¨×™×›×”</button>
      </div>
    </div>
    <div class="profile-tabs">
      <div class="ptab active" data-tab="prof-cases">ğŸ“ ×ª×™×§×™×</div>
      <div class="ptab" data-tab="prof-charges">ğŸ’° ×—×™×•×‘×™×</div>
      <div class="ptab" data-tab="prof-tasks">âœ… ××©×™××•×ª</div>
    </div>
    <div id="prof-cases" class="ptab-content active">
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>××¡×¤×¨</th><th>×©× ×”×ª×™×§</th><th>×¡×•×’</th><th>×¡×˜×˜×•×¡</th><th>×ª××¨×™×š</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
        <tbody id="prof-cases-tbody"></tbody>
      </table></div></div>
    </div>
    <div id="prof-charges" class="ptab-content">
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>×ª×™××•×¨</th><th>×¡×›×•×</th><th>×ª××¨×™×š</th><th>×¡×˜×˜×•×¡</th><th></th></tr></thead>
        <tbody id="prof-charges-tbody"></tbody>
      </table></div></div>
    </div>
    <div id="prof-tasks" class="ptab-content">
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>âœ“</th><th>××©×™××”</th><th>×ª×™×§</th><th>×ª××¨×™×š ××—×¨×•×Ÿ ×œ×‘×™×¦×•×¢</th><th>×¢×“×™×¤×•×ª</th></tr></thead>
        <tbody id="prof-tasks-tbody"></tbody>
      </table></div></div>
    </div>
  </div>

  <!-- â”€â”€ CASE PROFILE â”€â”€ -->
  <div id="view-case-profile" class="view page-content">
    <div class="action-row">
      <button class="btn btn-ghost" onclick="navTo('cases')">â† ×—×–×¨×” ×œ×ª×™×§×™×</button>
    </div>
    <!-- Case Header -->
    <div class="card" style="margin-bottom:18px;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
        <div>
          <div style="font-size:11px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px;" id="cp-num"></div>
          <div style="font-size:20px;font-weight:800;" id="cp-name"></div>
          <div style="display:flex;flex-wrap:wrap;gap:10px 20px;margin-top:10px;font-size:13px;color:var(--text2);" id="cp-meta"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-ghost btn-sm" id="cp-edit-btn">âœï¸ ×¢×¨×™×›×ª ×ª×™×§</button>
          <button class="btn btn-primary btn-sm" onclick="openCaseHearingModal()">+ ×“×™×•×Ÿ</button>
          <button class="btn btn-primary btn-sm" onclick="openCaseMeetingModal()">+ ×¤×’×™×©×”</button>
        </div>
      </div>
    </div>
    <!-- Case Tabs -->
    <div class="profile-tabs" id="case-tabs">
      <div class="ptab active" data-ctab="cp-log">ğŸ“‹ ×™×•××Ÿ ×¤×¢×•×œ×•×ª</div>
      <div class="ptab" data-ctab="cp-hearings">ğŸ› ×“×™×•× ×™×</div>
      <div class="ptab" data-ctab="cp-meetings">ğŸ¤ ×¤×’×™×©×•×ª</div>
      <div class="ptab" data-ctab="cp-tasks">âœ… ××©×™××•×ª</div>
      <div class="ptab" data-ctab="cp-charges">ğŸ’° ×—×™×•×‘×™×</div>
    </div>

    <!-- Log Tab -->
    <div id="cp-log" class="ctab-content active">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div class="card-title" style="margin:0;">ğŸ“‹ ×™×•××Ÿ ×¤×¢×•×œ×•×ª</div>
          <button class="btn btn-primary btn-sm" onclick="openLogEntry()">+ ×”×•×¡×£ ×¤×¢×•×œ×”</button>
        </div>
        <div id="cp-log-list"></div>
      </div>
    </div>

    <!-- Hearings Tab -->
    <div id="cp-hearings" class="ctab-content">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div class="card-title" style="margin:0;">ğŸ› ××•×¢×“×™ ×“×™×•×Ÿ</div>
          <button class="btn btn-primary btn-sm" onclick="openCaseHearingModal()">+ ×“×™×•×Ÿ ×—×“×©</button>
        </div>
        <div id="cp-hearings-list"></div>
      </div>
    </div>

    <!-- Meetings Tab -->
    <div id="cp-meetings" class="ctab-content">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div class="card-title" style="margin:0;">ğŸ¤ ×¤×’×™×©×•×ª</div>
          <button class="btn btn-primary btn-sm" onclick="openCaseMeetingModal()">+ ×¤×’×™×©×” ×—×“×©×”</button>
        </div>
        <div id="cp-meetings-list"></div>
      </div>
    </div>

    <!-- Tasks Tab -->
    <div id="cp-tasks" class="ctab-content">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div class="card-title" style="margin:0;">âœ… ××©×™××•×ª</div>
          <button class="btn btn-primary btn-sm" onclick="openTaskForCase()">+ ××©×™××”</button>
        </div>
        <div class="table-wrap"><table>
          <thead><tr><th>âœ“</th><th>××©×™××”</th><th>×ª××¨×™×š ××—×¨×•×Ÿ ×œ×‘×™×¦×•×¢</th><th>×¢×“×™×¤×•×ª</th><th></th></tr></thead>
          <tbody id="cp-tasks-tbody"></tbody>
        </table></div>
      </div>
    </div>

    <!-- Charges Tab -->
    <div id="cp-charges" class="ctab-content">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div class="card-title" style="margin:0;">ğŸ’° ×—×™×•×‘×™×</div>
          <button class="btn btn-primary btn-sm" onclick="openChargeForCase()">+ ×—×™×•×‘</button>
        </div>
        <div class="table-wrap"><table>
          <thead><tr><th>×ª×™××•×¨</th><th>×¡×›×•×</th><th>×ª××¨×™×š</th><th>×¡×˜×˜×•×¡</th><th></th></tr></thead>
          <tbody id="cp-charges-tbody"></tbody>
        </table></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ CASES â”€â”€ -->
  <div id="view-cases" class="view page-content">
    <div class="action-row">
      <button class="btn btn-primary" onclick="openNewCase()">+ ×ª×™×§ ×—×“×©</button>
      <select class="filter-select" id="cases-filter" onchange="renderCases()">
        <option value="">×›×œ ×”×ª×™×§×™×</option>
        <option value="active">×¤×¢×™×œ</option>
        <option value="pending">×××ª×™×Ÿ</option>
        <option value="urgent">×“×—×•×£</option>
        <option value="closed">×¡×’×•×¨</option>
      </select>
    </div>
    <div class="card">
      <div class="table-wrap"><table>
        <thead><tr><th>××¡×¤×¨</th><th>×©× ×”×ª×™×§</th><th>×œ×§×•×—</th><th>×¡×•×’</th><th>×ª×ª-×¡×•×’</th><th>×¡×˜×˜×•×¡</th><th>×ª××¨×™×š ×¤×ª×™×—×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
        <tbody id="cases-tbody"></tbody>
      </table></div>
    </div>
  </div>

  <!-- â”€â”€ TASKS â”€â”€ -->
  <div id="view-tasks" class="view page-content">
    <div class="action-row">
      <button class="btn btn-primary" onclick="openNewTask()">+ ××©×™××” ×—×“×©×”</button>
      <select class="filter-select" id="tasks-filter" onchange="renderTasks()">
        <option value="open">×¤×ª×•×—×•×ª</option>
        <option value="reminder">×ª×–×›×•×¨×ª ×œ×”×™×•×</option>
        <option value="all">×”×›×œ</option>
        <option value="done">×”×•×©×œ××•</option>
      </select>
    </div>
    <div class="card">
      <div class="table-wrap"><table>
        <thead><tr><th>âœ“</th><th>××©×™××”</th><th>×ª×™×§</th><th>×ª×–×›×•×¨×ª</th><th>×ª××¨×™×š ××—×¨×•×Ÿ ×œ×‘×™×¦×•×¢</th><th>×¢×“×™×¤×•×ª</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
        <tbody id="tasks-tbody"></tbody>
      </table></div>
    </div>
  </div>

  <!-- â”€â”€ CALENDAR â”€â”€ -->
  <div id="view-calendar" class="view page-content">
    <div class="action-row" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:8px;">
        <button class="btn btn-ghost btn-sm" onclick="calMove(-1)">â†’</button>
        <span id="cal-label" style="font-weight:700;font-size:15px;min-width:120px;text-align:center;"></span>
        <button class="btn btn-ghost btn-sm" onclick="calMove(1)">â†</button>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-ghost btn-sm" onclick="exportICS()">ğŸ“† ×™×™×¦×•× Apple</button>
        <button class="btn btn-primary btn-sm" onclick="openNewEvent()">+ ××™×¨×•×¢</button>
      </div>
    </div>
    <div class="card" style="padding:0;overflow:hidden;">
      <div class="cal-grid" id="cal-grid"></div>
    </div>
    <div class="hint">ğŸ’¡ ×œ×—×¦×™ ×¢×œ ×™×•× ×œ×”×•×¡×¤×ª ××™×¨×•×¢. ×œ×¡× ×›×¨×•×Ÿ ×¢× Apple Calendar â€” ×™×™×¦××™ ×§×•×‘×¥ .ics ×•×¤×ª×—×™ ××•×ª×• ×‘-Mac/iPhone.</div>
  </div>

  <!-- â”€â”€ CHARGES â”€â”€ -->
  <div id="view-charges" class="view page-content">
    <div class="action-row">
      <button class="btn btn-primary" onclick="openNewCharge()">+ ×—×™×•×‘ ×—×“×©</button>
      <select class="filter-select" id="charges-filter" onchange="renderCharges()">
        <option value="">×›×œ ×”×—×™×•×‘×™×</option>
        <option value="unpaid">×œ× ×©×•×œ×</option>
        <option value="partial">×©×•×œ× ×—×œ×§×™×ª</option>
        <option value="paid">×©×•×œ×</option>
      </select>
    </div>
    <div class="card" style="margin-bottom:14px;display:flex;gap:28px;align-items:center;flex-wrap:wrap;">
      <div>
        <div style="font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.06em;">×œ×’×‘×™×™×”</div>
        <div style="font-size:22px;font-weight:800;color:var(--danger);" id="total-unpaid">â‚ª0</div>
      </div>
      <div>
        <div style="font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.06em;">× ×’×‘×”</div>
        <div style="font-size:22px;font-weight:800;color:var(--success);" id="total-paid">â‚ª0</div>
      </div>
    </div>
    <div class="card">
      <div class="table-wrap"><table>
        <thead><tr><th>×ª×™××•×¨</th><th>×œ×§×•×— / ×ª×™×§</th><th>×œ×œ× ××¢×´×</th><th>×›×•×œ×œ ××¢×´×</th><th>×ª××¨×™×š</th><th>×¡×˜×˜×•×¡</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
        <tbody id="charges-tbody"></tbody>
      </table></div>
    </div>
  </div>


  <!-- SEARCH -->
  <div id="view-search" class="view page-content">
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title">ğŸ” ×—×™×¤×•×© ××ª×§×“×</div>
      <div class="form-row">
        <div class="form-group"><label>×˜×§×¡×˜ ×—×•×¤×©×™</label><input id="adv-text" placeholder="×©×, ××¡×¤×¨ ×ª×™×§, ×ª×™××•×¨..."></div>
        <div class="form-group"><label>×¡×•×’</label>
          <select id="adv-type">
            <option value="">×”×›×œ</option>
            <option value="client">×œ×§×•×—×•×ª</option>
            <option value="case">×ª×™×§×™×</option>
            <option value="task">××©×™××•×ª</option>
            <option value="charge">×—×™×•×‘×™×</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>×œ×§×•×—</label><select id="adv-client"><option value="">×›×œ ×”×œ×§×•×—×•×ª</option></select></div>
        <div class="form-group"><label>×¡×˜×˜×•×¡ ×ª×™×§</label>
          <select id="adv-status">
            <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
            <option value="active">×¤×¢×™×œ</option>
            <option value="pending">×××ª×™×Ÿ</option>
            <option value="urgent">×“×—×•×£</option>
            <option value="closed">×¡×’×•×¨</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>××ª××¨×™×š</label><input id="adv-from" type="date" dir="ltr"></div>
        <div class="form-group"><label>×¢×“ ×ª××¨×™×š</label><input id="adv-to" type="date" dir="ltr"></div>
      </div>
      <div style="margin-top:4px;"><button class="btn btn-primary" onclick="runAdvSearch()">ğŸ” ×—×™×¤×•×©</button></div>
    </div>
    <div id="adv-results"></div>
  </div>

</div><!-- /main -->

<!-- â•â•â•â• MOBILE NAV â•â•â•â• -->
<nav id="mob-nav">
  <div class="mob-nav-row">
    <div class="mni active" data-view="dashboard"><span class="mni-icon">ğŸ </span>×‘×™×ª</div>
    <div class="mni" data-view="clients"><span class="mni-icon">ğŸ‘¤</span>×œ×§×•×—×•×ª</div>
    <div class="mni" data-view="cases"><span class="mni-icon">ğŸ“</span>×ª×™×§×™×</div>
    <div class="mni" data-view="tasks" style="position:relative;">
      <span class="mni-icon">âœ…</span>
      <span class="mni-badge" id="mob-badge" style="display:none"></span>
      ××©×™××•×ª
    </div>
    <div class="mni" data-view="calendar"><span class="mni-icon">ğŸ“…</span>×™×•××Ÿ</div>
    <div class="mni" data-view="charges"><span class="mni-icon">ğŸ’°</span>×—×™×•×‘×™×</div>
  </div>
</nav>

<!-- â•â•â•â• MODALS â•â•â•â• -->

<!-- CLIENT -->
<div class="modal-overlay" id="modal-client">
  <div class="modal">
    <div class="modal-title" id="mc-title">ğŸ‘¤ ×œ×§×•×— ×—×“×©</div>
    <input type="hidden" id="mc-id">
    <div class="form-row">
      <div class="form-group"><label>×©× ×¤×¨×˜×™ *</label><input id="mc-firstname" placeholder="×™×©×¨××œ"></div>
      <div class="form-group"><label>×©× ××©×¤×—×” *</label><input id="mc-lastname" placeholder="×™×©×¨××œ×™"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>×ª.×–. / ×—.×¤.</label><input id="mc-idnum" placeholder="000000000"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>×˜×œ×¤×•×Ÿ</label><input id="mc-phone" type="tel" placeholder="050-0000000"></div>
      <div class="form-group"><label>×“×•××´×œ</label><input id="mc-email" type="email" placeholder="mail@example.com"></div>
    </div>
    <div class="form-group form-full"><label>×›×ª×•×‘×ª</label><input id="mc-addr" placeholder="×¨×—×•×‘, ×¢×™×¨"></div>
    <div class="form-group form-full"><label>×”×¢×¨×•×ª</label><textarea id="mc-notes" placeholder="×”×¢×¨×•×ª..."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveClient()">×©××™×¨×”</button>
      <button class="btn btn-ghost" onclick="closeModal('client')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- CASE -->
<div class="modal-overlay" id="modal-case">
  <div class="modal">
    <div class="modal-title" id="mcs-title">ğŸ“ ×ª×™×§ ×—×“×©</div>
    <input type="hidden" id="mcs-id">
    <div class="form-row">
      <div class="form-group"><label>×©× ×”×ª×™×§ *</label><input id="mcs-name" placeholder="×¤×œ×•× ×™ × ×³ ××œ××•× ×™"></div>
      <div class="form-group"><label>××¡×¤×¨ ×ª×™×§</label><input id="mcs-num" placeholder="2025-001"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>×œ×§×•×— *</label><select id="mcs-client"></select></div>
      <div class="form-group">
        <label style="display:flex;justify-content:space-between;align-items:center;">
          ×¡×•×’
          <span onclick="openModal('settings')" style="font-size:10px;color:var(--accent);cursor:pointer;font-weight:600;">âš™ï¸ ×¢×¨×•×š ×¡×•×’×™×</span>
        </label>
        <select id="mcs-type" onchange="updateSubtypes()">
        </select>
      </div>
    </div>
    <div class="form-row" id="subtype-row" style="display:none;">
      <div class="form-group form-full">
        <label style="display:flex;justify-content:space-between;align-items:center;">
          ×ª×ª-×¡×•×’
          <span onclick="openModal('settings')" style="font-size:10px;color:var(--accent);cursor:pointer;font-weight:600;">âš™ï¸ ×¢×¨×•×š ×ª×ª-×¡×•×’×™×</span>
        </label>
        <select id="mcs-subtype">
          <option value="">â€” ×‘×—×¨×™ ×ª×ª-×¡×•×’ â€”</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>×’×•×¨× ××¤× ×” <span onclick="openModal('settings')" style="font-size:10px;color:var(--accent2);cursor:pointer;font-weight:600;float:left;">âš™ï¸ ×¢×¨×•×š</span></label><select id="mcs-referrer"></select></div></div><div class="form-row"><div class="form-group"><label>×¡×˜×˜×•×¡</label><select id="mcs-status">
          <option value="active">×¤×¢×™×œ</option><option value="pending">×××ª×™×Ÿ</option>
          <option value="urgent">×“×—×•×£</option><option value="closed">×¡×’×•×¨</option>
        </select>
      </div>
      <div class="form-group"><label>×ª××¨×™×š ×¤×ª×™×—×”</label><input id="mcs-date" type="date" dir="ltr"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>×ª××¨×™×š ×¡×’×™×¨×”</label><input id="mcs-close-date" type="date" dir="ltr"></div><div class="form-group"><label>×–×™×”×•×™ × ×•×¡×£</label><input id="mcs-extra-id" placeholder="××¡×¤×¨ ×ª×™×§ ×‘×™×ª ××©×¤×˜, ×ª.×¤..."></div></div><div class="form-group form-full"><label>×¢×¨×›××” / ×‘×™×ª ××©×¤×˜</label><input id="mcs-court" placeholder='×‘×™×”×"×© ×©×œ×•× ×ª×œ ××‘×™×‘'></div>
    <div class="form-group form-full"><label>×ª×™××•×¨</label><textarea id="mcs-desc" placeholder="×ª×™××•×¨ ×§×¦×¨..."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveCase()">×©××™×¨×”</button>
      <button class="btn btn-ghost" onclick="closeModal('case')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- TASK -->
<div class="modal-overlay" id="modal-task">
  <div class="modal">
    <div class="modal-title" id="mt-title">âœ… ××©×™××” ×—×“×©×”</div>
    <input type="hidden" id="mt-id">
    <div class="form-group"><label>×›×•×ª×¨×ª *</label><input id="mt-title-inp" placeholder="×ª×™××•×¨ ×”××©×™××”"></div>
    <div class="form-row">
      <div class="form-group"><label>×ª×™×§ ×§×©×•×¨</label><select id="mt-case"><option value="">â€” ×œ×œ× â€”</option></select></div>
      <div class="form-group">
        <label>×¢×“×™×¤×•×ª</label>
        <select id="mt-prio">
          <option value="high">×’×‘×•×”×” ğŸ”´</option>
          <option value="med" selected>×‘×™× ×•× ×™×ª ğŸŸ¡</option>
          <option value="low">× ××•×›×” âšª</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>×ª××¨×™×š ×ª×–×›×•×¨×ª</label><input id="mt-reminder" type="date" dir="ltr"></div>
      <div class="form-group"><label>×ª××¨×™×š ××—×¨×•×Ÿ ×œ×‘×™×¦×•×¢</label><input id="mt-due" type="date" dir="ltr"></div>
    </div>
    <div class="form-group form-full"><label>×”×¢×¨×•×ª</label><textarea id="mt-notes" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveTask()">×©××™×¨×”</button>
      <button class="btn btn-ghost" onclick="closeModal('task')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- EVENT -->
<div class="modal-overlay" id="modal-event">
  <div class="modal">
    <div class="modal-title" id="mev-title">ğŸ“… ××™×¨×•×¢ ×—×“×©</div>
    <input type="hidden" id="mev-id">
    <div class="form-group"><label>×›×•×ª×¨×ª *</label><input id="mev-title-inp" placeholder="×“×™×•×Ÿ, ×¤×’×™×©×”, ××•×¢×“ ×”×’×©×”..."></div>
    <div class="form-row">
      <div class="form-group"><label>×ª××¨×™×š *</label><input id="mev-date" type="date" dir="ltr"></div>
      <div class="form-group"><label>×©×¢×ª ×”×ª×—×œ×”</label><input id="mev-time" type="time" dir="ltr"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>×©×¢×ª ×¡×™×•×</label><input id="mev-endtime" type="time" dir="ltr"></div>
      <div class="form-group"><label>×ª×™×§ ×§×©×•×¨</label><select id="mev-case"><option value="">â€” ×œ×œ× â€”</option></select></div>
    </div>
    <div class="form-group form-full"><label>××™×§×•×</label><input id="mev-loc" placeholder="×›×ª×•×‘×ª / ×§×™×©×•×¨ ×–×•×"></div>
    <div class="form-group form-full"><label>×”×¢×¨×•×ª</label><textarea id="mev-notes" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveEvent()">×©××™×¨×”</button>
      <button class="btn btn-ghost" onclick="closeModal('event')">×‘×™×˜×•×œ</button>
      <button class="btn btn-danger-soft btn-sm" id="mev-delete-btn" style="display:none;margin-right:auto" onclick="deleteEventFromModal()">ğŸ—‘ ××—×™×§×”</button>
    </div>
  </div>
</div>

<!-- CHARGE -->
<div class="modal-overlay" id="modal-charge">
  <div class="modal">
    <div class="modal-title" id="mch-title">ğŸ’° ×—×™×•×‘ ×—×“×©</div>
    <input type="hidden" id="mch-id">
    <div class="form-group">
      <label style="display:flex;justify-content:space-between;align-items:center;">
        ××—×™×¨×•×Ÿ â€” ×‘×—×¨×™ ×¡×•×’ ×—×™×•×‘
        <span onclick="openModal('settings');closeModal('charge')" style="font-size:10px;color:var(--accent);cursor:pointer;font-weight:600;">âš™ï¸ ×¢×¨×•×š ××—×™×¨×•×Ÿ</span>
      </label>
      <select id="mch-template" onchange="applyChargeTemplate()">
        <option value="">â€” ×‘×—×™×¨×” ××”××—×™×¨×•×Ÿ (××•×¤×¦×™×•× ×œ×™) â€”</option>
      </select>
    </div>
    <div class="form-group"><label>×ª×™××•×¨ *</label><input id="mch-desc" placeholder='×©×›"×˜ ×™×™×¢×•×¥, ×”×›× ×ª ×—×•×–×”...'></div>
    <div class="form-row">
      <div class="form-group"><label>×œ×§×•×— *</label><select id="mch-client" onchange="onChargeClient()"></select></div>
      <div class="form-group"><label>×ª×™×§ ×§×©×•×¨</label><select id="mch-case"><option value="">â€” ×œ×œ× â€”</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>×¡×›×•× ×œ×œ× ××¢×´× (â‚ª) *</label><input id="mch-amount" type="number" placeholder="0" min="0" oninput="updateVatPreview()"></div>
      <div class="form-group"><label>×ª××¨×™×š</label><input id="mch-date" type="date" dir="ltr"></div>
    </div>
    <div id="vat-preview" style="font-size:12px;color:var(--text2);margin:0 0 10px;padding:8px 10px;background:rgba(30,79,160,.07);border-radius:7px;display:none;"></div>
    <div class="form-row">
      <div class="form-group">
        <label>×¡×˜×˜×•×¡</label>
        <select id="mch-status">
          <option value="unpaid">×œ× ×©×•×œ×</option>
          <option value="partial">×©×•×œ× ×—×œ×§×™×ª</option>
          <option value="paid">×©×•×œ×</option>
        </select>
      </div>
      <div class="form-group"><label>×”×¢×¨×•×ª</label><input id="mch-notes" placeholder="×”×¢×¨×”..."></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveCharge()">×©××™×¨×”</button>
      <button class="btn btn-ghost" onclick="closeModal('charge')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- HEARING MODAL -->
<div class="modal-overlay" id="modal-hearing">
  <div class="modal">
    <div class="modal-title" id="mh-title">ğŸ› ×“×™×•×Ÿ ×—×“×©</div>
    <input type="hidden" id="mh-id">
    <input type="hidden" id="mh-caseid">
    <div class="form-group"><label>×ª×™××•×¨ ×”×“×™×•×Ÿ *</label><input id="mh-title-inp" placeholder='×“×™×•×Ÿ ×”×•×›×—×•×ª, ×§×“× ××©×¤×˜, ×’×–×¨ ×“×™×Ÿ...'></div>
    <div class="form-row">
      <div class="form-group"><label>×ª××¨×™×š *</label><input id="mh-date" type="date" dir="ltr"></div>
      <div class="form-group"><label>×©×¢×”</label><input id="mh-time" type="time" dir="ltr"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>××™×§×•× / ××•×œ×</label><input id="mh-loc" placeholder='×‘×™×”×"×© ×©×œ×•× ×ª"×, ××•×œ× 3'></div>
      <div class="form-group"><label>×©×•×¤×˜</label><input id="mh-judge" placeholder="×›×‘' ×”×©×•×¤×˜..."></div>
    </div>
    <div class="form-group form-full"><label>×”×¢×¨×•×ª</label><textarea id="mh-notes" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..."></textarea></div>
    <div class="form-group form-full" style="display:flex;align-items:center;gap:10px;background:rgba(90,156,245,.07);border:1px solid rgba(90,156,245,.2);border-radius:8px;padding:12px;">
      <input type="checkbox" id="mh-add-cal" style="width:16px;height:16px;accent-color:var(--accent);">
      <label style="margin:0;color:var(--text);cursor:pointer;font-size:13px;" for="mh-add-cal">ğŸ“… ×”×•×¡×£ ×’× ×œ×™×•××Ÿ ×”×›×œ×œ×™</label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveHearing()">×©××™×¨×”</button>
      <button class="btn btn-ghost" onclick="closeModal('hearing')">×‘×™×˜×•×œ</button>
      <button class="btn btn-danger-soft btn-sm" id="mh-del-btn" style="display:none;margin-right:auto" onclick="deleteHearing()">ğŸ—‘ ××—×™×§×”</button>
    </div>
  </div>
</div>

<!-- MEETING MODAL -->
<div class="modal-overlay" id="modal-meeting">
  <div class="modal">
    <div class="modal-title" id="mm-title">ğŸ¤ ×¤×’×™×©×” ×—×“×©×”</div>
    <input type="hidden" id="mm-id">
    <input type="hidden" id="mm-caseid">
    <div class="form-group"><label>× ×•×©× ×”×¤×’×™×©×” *</label><input id="mm-title-inp" placeholder="×¤×’×™×©×ª ×™×™×¢×•×¥, ×”×›× ×” ×œ×“×™×•×Ÿ..."></div>
    <div class="form-row">
      <div class="form-group"><label>×ª××¨×™×š *</label><input id="mm-date" type="date" dir="ltr"></div>
      <div class="form-group"><label>×©×¢×”</label><input id="mm-time" type="time" dir="ltr"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>×©×¢×ª ×¡×™×•×</label><input id="mm-endtime" type="time" dir="ltr"></div>
      <div class="form-group"><label>××™×§×•×</label><input id="mm-loc" placeholder="××©×¨×“, ×–×•×, ×˜×œ×¤×•×Ÿ..."></div>
    </div>
    <div class="form-group form-full"><label>×”×¢×¨×•×ª</label><textarea id="mm-notes" placeholder="× ×•×©××™× ×œ×“×™×•×Ÿ, ×¡×™×›×•×..."></textarea></div>
    <div class="form-group form-full" style="display:flex;align-items:center;gap:10px;background:rgba(90,156,245,.07);border:1px solid rgba(90,156,245,.2);border-radius:8px;padding:12px;">
      <input type="checkbox" id="mm-add-cal" style="width:16px;height:16px;accent-color:var(--accent);">
      <label style="margin:0;color:var(--text);cursor:pointer;font-size:13px;" for="mm-add-cal">ğŸ“… ×”×•×¡×£ ×’× ×œ×™×•××Ÿ ×”×›×œ×œ×™</label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveMeeting()">×©××™×¨×”</button>
      <button class="btn btn-ghost" onclick="closeModal('meeting')">×‘×™×˜×•×œ</button>
      <button class="btn btn-danger-soft btn-sm" id="mm-del-btn" style="display:none;margin-right:auto" onclick="deleteMeeting()">ğŸ—‘ ××—×™×§×”</button>
    </div>
  </div>
</div>

<!-- LOG ENTRY MODAL -->
<div class="modal-overlay" id="modal-log">
  <div class="modal">
    <div class="modal-title" id="ml-title">ğŸ“‹ ×”×•×¡×¤×ª ×¤×¢×•×œ×”</div>
    <input type="hidden" id="ml-id">
    <input type="hidden" id="ml-caseid">
    <div class="form-row">
      <div class="form-group"><label>×ª××¨×™×š *</label><input id="ml-date" type="date" dir="ltr"></div>
      <div class="form-group">
        <label>×¡×•×’ ×¤×¢×•×œ×”</label>
        <select id="ml-type">
          <option value="general">×›×œ×œ×™</option>
          <option value="filing">×”×’×©×ª ×›×ª×‘ ×‘×™×ª ×“×™×Ÿ</option>
          <option value="hearing">×“×™×•×Ÿ</option>
          <option value="decision">×”×—×œ×˜×” / ×¤×¡×§ ×“×™×Ÿ</option>
          <option value="correspondence">×”×ª×›×ª×‘×•×ª</option>
          <option value="research">××—×§×¨ ××©×¤×˜×™</option>
          <option value="other">××—×¨</option>
        </select>
      </div>
    </div>
    <div class="form-group form-full"><label>×ª×™××•×¨ ×”×¤×¢×•×œ×” *</label><textarea id="ml-text" placeholder="×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”×¤×¢×•×œ×” ×©×‘×•×¦×¢×”..." style="min-height:120px;"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveLogEntry()">×©××™×¨×”</button>
      <button class="btn btn-ghost" onclick="closeModal('log')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="modal-settings">
  <div class="modal" style="width:640px;">
    <div class="modal-title">âš™ï¸ ×”×’×“×¨×•×ª â€” ×¡×•×’×™ ×ª×™×§×™× ×•××—×™×¨×•×Ÿ</div>

    <!-- Case Types & Subtypes -->
    <div style="margin-bottom:24px;">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--accent);">ğŸ“ ×¡×•×’×™ ×ª×™×§×™× ×•×ª×ª-×¡×•×’×™×</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em;">×¡×•×’×™× ×¨××©×™×™×</div>
          <div id="types-list" style="border:1px solid var(--border);border-radius:8px;overflow:hidden;"></div>
          <div style="display:flex;gap:6px;margin-top:8px;">
            <input id="new-type-inp" placeholder="×¡×•×’ ×—×“×©..." style="flex:1;padding:7px 10px;font-size:12px;">
            <button class="btn btn-primary btn-sm" onclick="addCaseType()">+ ×”×•×¡×£</button>
          </div>
        </div>
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em;">×ª×ª-×¡×•×’×™× ×©×œ: <span id="selected-type-label" style="color:var(--accent);">â€” ×‘×—×¨×™ ×¡×•×’ â€”</span></div>
          <div id="subtypes-list" style="border:1px solid var(--border);border-radius:8px;overflow:hidden;min-height:60px;"></div>
          <div style="display:flex;gap:6px;margin-top:8px;">
            <input id="new-subtype-inp" placeholder="×ª×ª-×¡×•×’ ×—×“×©..." style="flex:1;padding:7px 10px;font-size:12px;">
            <button class="btn btn-primary btn-sm" onclick="addSubtype()">+ ×”×•×¡×£</button>
          </div>
        </div>
      </div>
    </div>

    <div style="border-top:1px solid var(--border);margin-bottom:20px;"></div>

    <!-- Charge Templates -->
    <div>
      <div style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--accent);">ğŸ’° ××—×™×¨×•×Ÿ ×—×™×•×‘×™×</div>
      <div id="charge-templates-list" style="border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:10px;"></div>
      <div style="display:grid;grid-template-columns:1fr 120px auto;gap:8px;align-items:end;">
        <div class="form-group" style="margin:0;"><label>×ª×™××•×¨</label><input id="new-tmpl-name" placeholder='×©×›"×˜ ×™×™×¢×•×¥, ×“×™×•×Ÿ, ×”×›× ×ª ×—×•×–×”...'></div>
        <div class="form-group" style="margin:0;"><label>××—×™×¨ (â‚ª)</label><input id="new-tmpl-price" type="number" placeholder="0" min="0"></div>
        <button class="btn btn-primary btn-sm" onclick="addChargeTemplate()" style="margin-bottom:1px;">+ ×”×•×¡×£</button>
      </div>
    </div>

    <div style="border-top:1px solid var(--border);margin-bottom:18px;"></div>
    <div style="margin-bottom:18px;">
      <div style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--accent);">ğŸ“¨ ×’×•×¨××™ ×”×¤× ×™×”</div>
      <div id="referrers-list" style="border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:8px;max-height:160px;overflow-y:auto;"></div>
      <div style="display:flex;gap:5px;">
        <input id="new-referrer-inp" placeholder="×’×•×¨× ×”×¤× ×™×” ×—×“×©..." style="flex:1;padding:6px 9px;font-size:12px;">
        <button class="btn btn-primary btn-sm" onclick="addReferrer()">+ ×”×•×¡×£</button>
      </div>
    </div>

    <div style="border-top:1px solid var(--border);margin-bottom:16px;"></div>
    <div>
      <div style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--accent);">ğŸ§¾ ×©×™×¢×•×¨ ××¢×´×</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <input id="vat-rate-inp" type="number" min="0" max="100" style="width:90px;" placeholder="18">
        <span style="font-size:13px;color:var(--text2);">××—×•×–</span>
        <button class="btn btn-primary btn-sm" onclick="saveVatRate()">×¢×“×›×Ÿ</button>
        <span id="vat-rate-display" style="font-size:12px;color:var(--text3);"></span>
      </div>
    </div>

    <div class="modal-actions" style="margin-top:20px;">
      <button class="btn btn-ghost" onclick="closeModal('settings')">×¡×’×™×¨×”</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-backup">
  <div class="modal">
    <div class="modal-title">â˜ï¸ ×’×™×‘×•×™ ×•×©×—×–×•×¨ × ×ª×•× ×™×</div>

    <div class="bk-option" onclick="exportJSON()">
      <h4>ğŸ“¥ ×™×™×¦×•× JSON</h4>
      <p>×”×•×¨×“×ª ×§×•×‘×¥ ×’×™×‘×•×™ ××œ× ×œ××—×©×‘. ×©××¨×™ ×‘-iCloud Drive â€” ×™×¡×ª× ×›×¨×Ÿ ××•×˜×•××˜×™×ª ×‘×™×Ÿ Mac ×•-iPhone ×©×œ×š.</p>
    </div>

    <div class="bk-option" onclick="triggerImport();closeModal('backup')">
      <h4>ğŸ“¤ ×™×™×‘×•× ××§×•×‘×¥ JSON</h4>
      <p>×©×—×–×•×¨ × ×ª×•× ×™× ××§×•×‘×¥ ×’×™×‘×•×™ ×©× ×©××¨ ×§×•×“×.</p>
    </div>

    <div class="bk-option">
      <h4>ğŸŸ¢ Google Drive â€” ×’×™×‘×•×™ ××•×˜×•××˜×™</h4>
      <p>×”×ª×—×‘×¨×™ ×¤×¢× ××—×ª, ×•××¢×›×©×™×• ×”× ×ª×•× ×™× ×™×™×©××¨×• ××•×˜×•××˜×™×ª ×‘-Google Drive ×©×œ×š.</p>
      <div class="bk-btns">
        <button class="btn btn-primary btn-sm" onclick="gdriveConnect()">ğŸ”— ×”×ª×—×‘×¨×•×ª</button>
        <button class="btn btn-ghost btn-sm" onclick="gdriveSave()">ğŸ’¾ ×©××•×¨ ×¢×›×©×™×•</button>
        <button class="btn btn-ghost btn-sm" onclick="gdriveLoad()">ğŸ”„ ×©×—×–×¨ ××”×¢× ×Ÿ</button>
      </div>
      <div id="gdrive-status"></div>
      <div class="hint" style="margin-top:10px;">
        âœ… Google Drive ××•×’×“×¨ ×•××•×›×Ÿ ×œ×©×™××•×©. ×œ×—×¦×™ "×”×ª×—×‘×¨×•×ª" ×‘×›×œ ×¤×¢× ×©×ª×¤×ª×—×™ ××ª ×”××¤×œ×™×§×¦×™×” ××—×“×©.
      </div>
    </div>

    <div class="hint">
      ğŸ“± <strong>iCloud Drive:</strong> ×™×™×¦××™ JSON â† ×©××¨×™ ×‘-iCloud Drive â† × ×™×’×© ××›×œ ×”××›×©×™×¨×™× ×©×œ×š ××•×˜×•××˜×™×ª
    </div>

    <div class="modal-actions" style="margin-top:16px;">
      <button class="btn btn-ghost" onclick="closeModal('backup')">×¡×’×™×¨×”</button>
    </div>
  </div>
</div>

<!-- â•â•â•â• SCRIPT â•â•â•â• -->

<!-- EXPORT TASKS MODAL -->
<div class="modal-overlay" id="modal-export-tasks">
  <div class="modal">
    <div class="modal-title">ğŸ“„ ×™×™×¦×•× ××©×™××•×ª ×œ×§×•×‘×¥</div>
    <div class="form-row">
      <div class="form-group"><label>×œ×§×•×—</label><select id="exp-client"><option value="">×›×œ ×”×œ×§×•×—×•×ª</option></select></div>
      <div class="form-group"><label>×ª×™×§</label><select id="exp-case"><option value="">×›×œ ×”×ª×™×§×™×</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>×ª×–×›×•×¨×ª ×-</label><input id="exp-reminder-from" type="date" dir="ltr"></div>
      <div class="form-group"><label>×ª×–×›×•×¨×ª ×¢×“</label><input id="exp-reminder-to" type="date" dir="ltr"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>×ª××¨×™×š ××—×¨×•×Ÿ ×-</label><input id="exp-due-from" type="date" dir="ltr"></div>
      <div class="form-group"><label>×ª××¨×™×š ××—×¨×•×Ÿ ×¢×“</label><input id="exp-due-to" type="date" dir="ltr"></div>
    </div>
    <div class="form-group"><label>×¡×˜×˜×•×¡</label>
      <select id="exp-status">
        <option value="open">×¤×ª×•×—×•×ª ×‘×œ×‘×“</option>
        <option value="all">×”×›×œ</option>
        <option value="done">×”×•×©×œ××• ×‘×œ×‘×“</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="exportTasksCSV()">ğŸ“„ ×™×™×¦×•× CSV</button>
      <button class="btn btn-ghost" onclick="closeModal('export-tasks')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<script>
// â•â• STATE â•â•
let DB = {
  clients:[],cases:[],tasks:[],events:[],charges:[],_id:1
};
let calY = new Date().getFullYear();
let calM = new Date().getMonth();
let currentView = 'dashboard';
let profileClientId = null;

// â•â• PERSIST â•â•
const STORE_KEY = 'lm_v3';
function dbSave(){
  try{localStorage.setItem(STORE_KEY,JSON.stringify(DB));}catch(e){}
  // auto-gdrive if connected
  if(gdriveToken) setTimeout(gdriveSave,500);
}
function dbLoad(){
  try{const d=localStorage.getItem(STORE_KEY);if(d)DB=JSON.parse(d);}catch(e){}
}
function uid(){return DB._id++;}

// â•â• HELPERS â•â•
function today(){return new Date().toISOString().split('T')[0];}
function fdate(d){if(!d)return'â€”';const[y,m,dd]=d.split('-');return`${dd}.${m}.${y}`;}
function ftime(t){if(!t)return'';return`<span dir="ltr">${t.substring(0,5)}</span>`;}
function clientName(id){const c=DB.clients.find(x=>x.id==id);return c?c.name:'â€”';}
function caseName(id){const c=DB.cases.find(x=>x.id==id);return c?c.name:'â€”';}
function initials(name){if(!name)return'?';const p=name.trim().split(' ');return(p[0][0]+(p[1]?p[1][0]:'')).toUpperCase();}
function isOverdue(d){return d&&d<today();}

function vatRate(){return(DB.vatRate||18)/100;}
function withVat(n){return Math.round(n*(1+vatRate()));}


function statusTag(s){
  const m={active:'tag-active ×¤×¢×™×œ',closed:'tag-closed ×¡×’×•×¨',pending:'tag-pending ×××ª×™×Ÿ',
    urgent:'tag-urgent ×“×—×•×£',paid:'tag-paid ×©×•×œ×',unpaid:'tag-unpaid ×œ× ×©×•×œ×',partial:'tag-partial ×—×œ×§×™'};
  const v=m[s]||s;const[cls,...words]=v.split(' ');
  return`<span class="tag ${cls}">${words.join(' ')}</span>`;
}
function prioLabel(p){
  if(p==='high')return'<span class="priority-high">×’×‘×•×”×” â†‘</span>';
  if(p==='med')return'<span class="priority-med">×‘×™× ×•× ×™×ª</span>';
  return'<span class="priority-low">× ××•×›×”</span>';
}

function fillCaseSelect(selId,clientId){
  const sel=document.getElementById(selId);
  if(!sel)return;
  const prev=sel.value;
  sel.innerHTML='<option value="">â€” ×œ×œ× â€”</option>';
  let cases=DB.cases;
  if(clientId)cases=cases.filter(c=>c.clientId==clientId);
  cases.forEach(c=>sel.innerHTML+=`<option value="${c.id}">${c.name}</option>`);
  if(prev)sel.value=prev;
}
function fillClientSelect(selId){
  const sel=document.getElementById(selId);
  if(!sel)return;
  const prev=sel.value;
  sel.innerHTML='<option value="">â€” ×‘×—×¨ ×œ×§×•×— â€”</option>';
  DB.clients.forEach(c=>sel.innerHTML+=`<option value="${c.id}">${c.name}</option>`);
  if(prev)sel.value=prev;
}

// â•â• NAV â•â•
const PAGE_TITLES={
  dashboard:['××¡×š ×”×‘×™×ª','×¡×§×™×¨×” ×›×œ×œ×™×ª'],
  clients:['×œ×§×•×—×•×ª','× ×™×”×•×œ ×œ×§×•×—×•×ª'],
  'client-profile':['×¤×¨×•×¤×™×œ ×œ×§×•×—',''],
  'case-profile':['×ª×™×§',''],search:['×—×™×¤×•×©','×—×™×¤×•×© ××ª×§×“×'],
  cases:['×ª×™×§×™×','× ×™×”×•×œ ×ª×™×§×™×'],
  tasks:['××©×™××•×ª','× ×™×”×•×œ ××©×™××•×ª'],
  calendar:['×™×•××Ÿ','××™×¨×•×¢×™× ×•××•×¢×“×™×'],
  charges:['×—×™×•×‘×™×','× ×™×”×•×œ ×—×™×•×‘×™×']
};

function navTo(view){
  currentView=view;
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const vEl=document.getElementById('view-'+view);if(!vEl)return;vEl.classList.add('active');
  const[t,s]=PAGE_TITLES[view]||[view,''];
  document.getElementById('dt-title').textContent=t;
  document.getElementById('dt-sub').textContent=s;
  document.getElementById('mob-title').textContent=t;
  document.querySelectorAll('#sidebar .nav-item').forEach(el=>{
    el.classList.toggle('active',el.dataset.view===view);
  });
  document.querySelectorAll('.mni').forEach(el=>{
    el.classList.toggle('active',el.dataset.view===view);
  });
  const addBtn=document.getElementById('mob-add');
  addBtn.style.display=(view==='dashboard'||view==='client-profile'||view==='case-profile')?'none':'inline-flex';
  // render
  const renders={
    dashboard:renderDashboard,
    clients:renderClients,
    cases:renderCases,
    tasks:renderTasks,
    calendar:renderCalendar,
    charges:renderCharges
  };
  if(renders[view])renders[view]();
}

// sidebar nav items
document.querySelectorAll('#sidebar .nav-item').forEach(el=>{
  el.addEventListener('click',()=>navTo(el.dataset.view));
});
// mobile nav items
document.querySelectorAll('.mni').forEach(el=>{
  el.addEventListener('click',()=>navTo(el.dataset.view));
});

function mobileAdd(){
  const map={
    clients:()=>openModal('client'),
    cases:()=>openNewCase(),
    tasks:()=>openNewTask(),
    calendar:()=>openNewEvent(),
    charges:()=>openNewCharge()
  };
  if(map[currentView])map[currentView]();
}

// â•â• MODALS â•â•
function openModal(type){
  if(type==='settings'){openModal_settings();return;}
  if(type==='case'){
    fillClientSelect('mcs-client');
    fillCaseTypeSelect();
    // fill referrer select
    const rsel=document.getElementById('mcs-referrer');
    if(rsel){
      const prev=rsel.value;
      rsel.innerHTML='<option value="">â€” ×‘×—×¨×™ ×’×•×¨× ××¤× ×” â€”</option>';
      (DB.referrers||[]).forEach(r=>rsel.innerHTML+=`<option value="${r}">${r}</option>`);
      if(prev)rsel.value=prev;
    }
  }
  if(type==='task')fillCaseSelect('mt-case');
  if(type==='event')fillCaseSelect('mev-case');
  if(type==='charge'){fillClientSelect('mch-client');fillCaseSelect('mch-case');fillChargeTemplateSelect();}
  document.getElementById('modal-'+type).classList.add('open');
}

function fillReferrerSelect(selId){
  const sel=document.getElementById(selId);if(!sel)return;
  const prev=sel.value;
  sel.innerHTML='<option value="">â€” ×‘×—×¨×™ ×’×•×¨× ××¤× ×” â€”</option>';
  (DB.referrers||[]).forEach(r=>sel.innerHTML+=`<option value="${r}">${r}</option>`);
  if(prev)sel.value=prev;
}
function closeModal(type){
  document.getElementById('modal-'+type).classList.remove('open');
}
document.querySelectorAll('.modal-overlay').forEach(el=>{
  el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');});
});

// â•â• BADGE â•â•
function updateBadge(){
  const n=DB.tasks.filter(t=>!t.done).length;
  document.getElementById('sb-badge').textContent=n;
  const mb=document.getElementById('mob-badge');
  mb.textContent=n;mb.style.display=n>0?'inline-block':'none';
}

// â•â• CLIENTS â•â•
function saveClient(){
  const firstName=document.getElementById('mc-firstname').value.trim();
  const lastName=document.getElementById('mc-lastname').value.trim();
  if(!firstName&&!lastName){alert('×™×© ×œ×”×–×™×Ÿ ×©× ×¤×¨×˜×™ ××• ×©× ××©×¤×—×”');return;}
  const name=(firstName+' '+lastName).trim();
  const eid=document.getElementById('mc-id').value;
  const obj={
    id:eid||uid(),name,
    idNum:document.getElementById('mc-idnum').value,
    phone:document.getElementById('mc-phone').value,
    email:document.getElementById('mc-email').value,
    addr:document.getElementById('mc-addr').value,
    notes:document.getElementById('mc-notes').value,
    created:today()
  };
  if(eid){const i=DB.clients.findIndex(c=>c.id==eid);DB.clients[i]=obj;}
  else DB.clients.push(obj);
  dbSave();closeModal('client');
  if(currentView==='clients')renderClients();
  else if(currentView==='client-profile')renderProfile(obj.id);
  renderDashboard();
}

function editClient(id){
  const c=DB.clients.find(x=>x.id==id);if(!c)return;
  document.getElementById('mc-title').textContent='âœï¸ ×¢×¨×™×›×ª ×œ×§×•×—';
  document.getElementById('mc-id').value=c.id;
  const nameParts=(c.name||'').trim().split(' ');
  document.getElementById('mc-firstname').value=nameParts.slice(0,-1).join(' ')||c.name||'';
  document.getElementById('mc-lastname').value=nameParts.length>1?nameParts[nameParts.length-1]:'';
  document.getElementById('mc-idnum').value=c.idNum||'';
  document.getElementById('mc-phone').value=c.phone||'';
  document.getElementById('mc-email').value=c.email||'';
  document.getElementById('mc-addr').value=c.addr||'';
  document.getElementById('mc-notes').value=c.notes||'';
  document.getElementById('modal-client').classList.add('open');
}

function deleteClient(id){
  if(!confirm('×œ××—×•×§ ×œ×§×•×— ×–×”?'))return;
  DB.clients=DB.clients.filter(c=>c.id!=id);
  dbSave();renderClients();renderDashboard();
}

function openProfile(id){
  profileClientId=id;
  renderProfile(id);
  navTo('client-profile');
}

function renderProfile(id){
  const c=DB.clients.find(x=>x.id==id);if(!c)return;
  document.getElementById('prof-avatar').textContent=initials(c.name);
  document.getElementById('prof-name').textContent=c.name;
  const details=[];
  if(c.idNum)details.push('ğŸªª '+c.idNum);
  if(c.phone)details.push('ğŸ“ '+c.phone);
  if(c.email)details.push('âœ‰ï¸ '+c.email);
  if(c.addr)details.push('ğŸ“ '+c.addr);
  document.getElementById('prof-details').innerHTML=details.map(d=>`<span>${d}</span>`).join('');
  document.getElementById('prof-edit-btn').onclick=()=>editClient(c.id);
  // tabs
  const clientCases=DB.cases.filter(cs=>cs.clientId==id);
  document.getElementById('prof-cases-tbody').innerHTML=clientCases.length
    ?clientCases.map(cs=>`<tr>
      <td>${cs.num||'â€”'}</td>
      <td><span class="case-row-link" onclick="openCaseProfile(${cs.id})">${cs.name}</span></td>
      <td>${cs.type}</td><td>${statusTag(cs.status)}</td>
      <td>${fdate(cs.date)}</td>
      <td><div style="display:flex;gap:6px;">
        <button class="btn btn-ghost btn-xs" onclick="openCaseProfile(${cs.id})">ğŸ“‚</button>
        <button class="btn btn-ghost btn-xs" onclick="editCase(${cs.id})">âœï¸</button>
      </div></td>
    </tr>`).join('')
    :'<tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ“</div><div class="empty-text">××™×Ÿ ×ª×™×§×™×</div></div></td></tr>';

  const clientCharges=DB.charges.filter(ch=>ch.clientId==id);
  document.getElementById('prof-charges-tbody').innerHTML=clientCharges.length
    ?clientCharges.map(ch=>`<tr>
      <td>${ch.desc}</td>
      <td><span class="amount">â‚ª${Number(ch.amount).toLocaleString()}</span></td>
      <td>${fdate(ch.date)}</td>
      <td><select class="qs-select" onchange="quickChargeStatus(${ch.id},this.value)">
        <option value="unpaid"${ch.status==='unpaid'?' selected':''}>×œ× ×©×•×œ×</option>
        <option value="partial"${ch.status==='partial'?' selected':''}>×—×œ×§×™</option>
        <option value="paid"${ch.status==='paid'?' selected':''}>×©×•×œ×</option>
      </select></td>
      <td><button class="btn btn-ghost btn-xs" onclick="editCharge(${ch.id})">âœï¸</button></td>
    </tr>`).join('')
    :'<tr><td colspan="5"><div class="empty"><div class="empty-icon">ğŸ’°</div><div class="empty-text">××™×Ÿ ×—×™×•×‘×™×</div></div></td></tr>';

  // tasks by cases of this client
  const caseIds=clientCases.map(cs=>cs.id.toString());
  const clientTasks=DB.tasks.filter(t=>caseIds.includes(t.caseId?.toString()));
  document.getElementById('prof-tasks-tbody').innerHTML=clientTasks.length
    ?clientTasks.map(t=>`<tr class="${t.done?'task-done':''}">
      <td><input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" style="accent-color:var(--accent)"></td>
      <td><strong>${t.title}</strong></td><td>${caseName(t.caseId)}</td>
      <td>${t.due?`<span style="color:${isOverdue(t.due)&&!t.done?'var(--danger)':'inherit'}">${fdate(t.due)}</span>`:'â€”'}</td>
      <td>${prioLabel(t.prio)}</td>
    </tr>`).join('')
    :'<tr><td colspan="5"><div class="empty"><div class="empty-icon">âœ…</div><div class="empty-text">××™×Ÿ ××©×™××•×ª</div></div></td></tr>';
}

// profile tabs
document.querySelectorAll('.ptab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.ptab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.ptab-content').forEach(c=>c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

function renderClients(filter){
  const grid=document.getElementById('clients-grid');
  let list=DB.clients;
  if(filter){const q=filter.toLowerCase();list=list.filter(c=>c.name.toLowerCase().includes(q)||(c.phone||'').includes(q)||(c.email||'').toLowerCase().includes(q));}
  if(!list.length){grid.innerHTML='<div class="empty"><div class="empty-icon">ğŸ‘¤</div><div class="empty-text">××™×Ÿ ×œ×§×•×—×•×ª ×¢×“×™×™×Ÿ</div></div>';return;}
  grid.innerHTML=list.map(c=>{
    const n=DB.cases.filter(cs=>cs.clientId==c.id).length;
    return`<div class="client-card" onclick="openProfile(${c.id})">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div class="cc-name">${c.name}</div>
          <div class="cc-id">${c.idNum?'×ª.×–. '+c.idNum:''}</div>
        </div>
        <div style="background:rgba(201,168,76,.12);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:var(--accent);">${initials(c.name)}</div>
      </div>
      <div class="cc-meta">
        ${c.phone?`<span>ğŸ“ ${c.phone}</span>`:''}
        ${c.email?`<span>âœ‰ï¸ ${c.email}</span>`:''}
        <span>ğŸ“ ${n} ×ª×™×§×™×</span>
      </div>
      <div class="cc-actions">
        <button class="btn btn-ghost btn-xs" onclick="event.stopPropagation();editClient(${c.id})">âœï¸ ×¢×¨×™×›×”</button>
        <button class="btn btn-ghost btn-xs" onclick="event.stopPropagation();openNewCase()" style="margin-right:auto">+ ×ª×™×§</button>
        <button class="btn btn-danger-soft btn-xs" onclick="event.stopPropagation();deleteClient(${c.id})">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

// â•â• CASE PROFILE â•â•
let activeCaseId = null;

function openCaseProfile(id) {
  activeCaseId = id;
  renderCaseProfile(id);
  navTo('case-profile');
}

function renderCaseProfile(id) {
  const c = DB.cases.find(x => x.id == id); if (!c) return;
  document.getElementById('cp-num').textContent = c.num ? '×ª×™×§ ××¡×³ ' + c.num : '';
  document.getElementById('cp-name').textContent = c.name;
  const meta = [];
  meta.push('ğŸ‘¤ ' + clientName(c.clientId));
  meta.push('âš–ï¸ ' + c.type + (c.subtype ? ' Â· ' + c.subtype : ''));
  if (c.court) meta.push('ğŸ› ' + c.court);
  if(c.referrer)meta.push('ğŸ“¨ '+c.referrer);
  if (c.date) meta.push('ğŸ“… × ×¤×ª×— ' + fdate(c.date));
  if(c.updated)meta.push('ğŸ”„ ×¢×•×“×›×Ÿ '+fdate(c.updated));
  if(c.closeDate)meta.push('ğŸ”’ × ×¡×’×¨ '+fdate(c.closeDate));
  if(c.extraId)meta.push('ğŸ”– '+c.extraId);
  meta.push(statusTag(c.status));
  document.getElementById('cp-meta').innerHTML = meta.map(m => `<span>${m}</span>`).join('');
  document.getElementById('cp-edit-btn').onclick = () => editCase(id);

  // Log
  const logs = (c.log || []).slice().sort((a, b) => b.date.localeCompare(a.date));
  const logEl = document.getElementById('cp-log-list');
  if (!logs.length) {
    logEl.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">×˜×¨× × ×¨×©××• ×¤×¢×•×œ×•×ª ×‘×ª×™×§ ×–×”</div></div>';
  } else {
    const typeLabels = {general:'×›×œ×œ×™',filing:'×”×’×©×ª ×›×ª×‘',hearing:'×“×™×•×Ÿ',decision:'×”×—×œ×˜×”',correspondence:'×”×ª×›×ª×‘×•×ª',research:'××—×§×¨',other:'××—×¨'};
    logEl.innerHTML = logs.map(entry => `
      <div class="log-entry">
        <div class="log-entry-date">${fdate(entry.date)} Â· <span style="color:var(--accent)">${typeLabels[entry.type]||entry.type}</span></div>
        <div class="log-entry-text">${escHtml(entry.text)}</div>
        <div class="log-entry-actions">
          <button class="btn btn-ghost btn-xs" onclick="editLogEntry(${id},'${entry.id}')" title="×¢×¨×™×›×”">âœï¸</button>
          <button class="btn btn-danger-soft btn-xs" onclick="deleteLogEntry(${id},'${entry.id}')" title="××—×™×§×”">ğŸ—‘</button>
        </div>
      </div>`).join('');
  }

  // Hearings
  renderCaseHearings(c);
  // Meetings
  renderCaseMeetings(c);
  // Tasks
  const caseTasks = DB.tasks.filter(t => t.caseId == id);
  const ctbody = document.getElementById('cp-tasks-tbody');
  ctbody.innerHTML = caseTasks.length ? caseTasks.map(t => `<tr class="${t.done?'task-done':''}">
    <td><input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" style="accent-color:var(--accent);width:15px;height:15px;"></td>
    <td><strong>${t.title}</strong></td>
    <td>${t.reminder?`<span style="color:${isOverdue(t.reminder)&&!t.done?'var(--danger)':'var(--text2)'};">${fdate(t.reminder)}</span>`:'â€”'}</td>
    <td>${t.due?`<span style="color:${isOverdue(t.due)&&!t.done?'var(--danger)':'inherit'}">${fdate(t.due)}</span>`:'â€”'}</td>
    <td>${prioLabel(t.prio)}</td>
    <td><button class="btn btn-ghost btn-xs" onclick="editTask(${t.id})">âœï¸</button></td>
  </tr>`).join('')
  : '<tr><td colspan="5"><div class="empty" style="padding:24px;"><div class="empty-icon" style="font-size:28px;">âœ…</div><div class="empty-text">××™×Ÿ ××©×™××•×ª</div></div></td></tr>';

  // Charges
  const caseCharges = DB.charges.filter(ch => ch.caseId == id);
  const ccbody = document.getElementById('cp-charges-tbody');
  ccbody.innerHTML = caseCharges.length ? caseCharges.map(ch => `<tr>
    <td>${ch.desc}</td>
    <td><span class="amount">â‚ª${Number(ch.amount).toLocaleString()}</span></td>
    <td>${fdate(ch.date)}</td>
    <td><select class="qs-select" onchange="quickChargeStatus(${ch.id},this.value)">
      <option value="unpaid"${ch.status==='unpaid'?' selected':''}>×œ× ×©×•×œ×</option>
      <option value="partial"${ch.status==='partial'?' selected':''}>×—×œ×§×™</option>
      <option value="paid"${ch.status==='paid'?' selected':''}>×©×•×œ×</option>
    </select></td>
    <td><div style="display:flex;gap:5px;">
      <button class="btn btn-ghost btn-xs" onclick="duplicateCharge(${ch.id})" title="×©×›×¤×•×œ">â§‰</button>
      <button class="btn btn-ghost btn-xs" onclick="editCharge(${ch.id})">âœï¸</button>
      <button class="btn btn-danger-soft btn-xs" onclick="deleteCharge(${ch.id})">ğŸ—‘</button>
    </div></td>
  </tr>`).join('')
  : '<tr><td colspan="5"><div class="empty" style="padding:24px;"><div class="empty-icon" style="font-size:28px;">ğŸ’°</div><div class="empty-text">××™×Ÿ ×—×™×•×‘×™×</div></div></td></tr>';
}

function renderCaseHearings(c) {
  const hearings = [...(c.hearings || [])].sort((a, b) => (a.date + (a.time||'')).localeCompare(b.date + (b.time||'')));
  const el = document.getElementById('cp-hearings-list');
  if (!hearings.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ›</div><div class="empty-text">×œ× ×”×•×’×“×¨×• ××•×¢×“×™ ×“×™×•×Ÿ</div></div>'; return; }
  const td = today();
  el.innerHTML = hearings.map(h => {
    const isPast = h.date < td;
    const isNext = !isPast && hearings.find(x => x.date >= td) === h;
    const parts = h.date.split('-');
    return `<div class="cev-item ${isPast?'cev-past':''} ${isNext?'cev-next':''}">
      <div class="cev-date-block">
        <div class="cev-month">${HM[parseInt(parts[1])-1]}</div>
        <div class="cev-day">${parseInt(parts[2])}</div>
        <div style="font-size:10px;color:var(--text3);">${parts[0]}</div>
      </div>
      <div class="cev-info">
        <div class="cev-title">${escHtml(h.title)}</div>
        <div class="cev-sub">${h.time?ftime(h.time)+' Â· ':''}${h.loc?h.loc+' Â· ':''}${h.judge?'×›×‘×³ '+escHtml(h.judge):''}${h.notes?`<br><span style="color:var(--text3)">${escHtml(h.notes)}</span>`:''}</div>
      </div>
      <div style="display:flex;gap:4px;flex-shrink:0;">
        <button class="btn btn-ghost btn-xs" onclick="duplicateHearing('${h.id}')" title="×©×›×¤×•×œ ×“×™×•×Ÿ">â§‰</button>
        <button class="btn btn-ghost btn-xs" onclick="editHearing('${h.id}')">âœï¸</button>
        <button class="btn btn-danger-soft btn-xs" onclick="deleteHearingById('${h.id}')">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

function renderCaseMeetings(c) {
  const meetings = [...(c.meetings || [])].sort((a, b) => (a.date + (a.time||'')).localeCompare(b.date + (b.time||'')));
  const el = document.getElementById('cp-meetings-list');
  if (!meetings.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ¤</div><div class="empty-text">×œ× × ×§×‘×¢×• ×¤×’×™×©×•×ª</div></div>'; return; }
  const td = today();
  el.innerHTML = meetings.map(m => {
    const isPast = m.date < td;
    const isNext = !isPast && meetings.find(x => x.date >= td) === m;
    const parts = m.date.split('-');
    return `<div class="cev-item ${isPast?'cev-past':''} ${isNext?'cev-next':''}">
      <div class="cev-date-block">
        <div class="cev-month">${HM[parseInt(parts[1])-1]}</div>
        <div class="cev-day">${parseInt(parts[2])}</div>
        <div style="font-size:10px;color:var(--text3);">${parts[0]}</div>
      </div>
      <div class="cev-info">
        <div class="cev-title">${escHtml(m.title)}</div>
        <div class="cev-sub">${m.time?ftime(m.time):''}${m.endTime?' â€” '+ftime(m.endTime):''}${m.loc?' Â· '+escHtml(m.loc):''}${m.notes?`<br><span style="color:var(--text3)">${escHtml(m.notes)}</span>`:''}</div>
      </div>
      <div style="display:flex;gap:4px;flex-shrink:0;">
        <button class="btn btn-ghost btn-xs" onclick="editMeeting('${m.id}')">âœï¸</button>
        <button class="btn btn-danger-soft btn-xs" onclick="deleteMeetingById('${m.id}')">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

function escHtml(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Case tabs
document.querySelectorAll('[data-ctab]').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('[data-ctab]').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.ctab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.ctab).classList.add('active');
  });
});

// â•â• LOG ENTRIES â•â•
function openLogEntry(id) {
  document.getElementById('ml-title').textContent = 'ğŸ“‹ ×”×•×¡×¤×ª ×¤×¢×•×œ×”';
  document.getElementById('ml-id').value = '';
  document.getElementById('ml-caseid').value = activeCaseId;
  document.getElementById('ml-date').value = today();
  document.getElementById('ml-text').value = '';
  document.getElementById('ml-type').value = 'general';
  document.getElementById('modal-log').classList.add('open');
}

function saveLogEntry() {
  const text = document.getElementById('ml-text').value.trim();
  const date = document.getElementById('ml-date').value;
  if (!text || !date) { alert('×ª××¨×™×š ×•×ª×™××•×¨ ×—×•×‘×”'); return; }
  const cid = document.getElementById('ml-caseid').value;
  const c = DB.cases.find(x => x.id == cid); if (!c) return;
  if (!c.log) c.log = [];
  const eid = document.getElementById('ml-id').value;
  if (eid) {
    const entry = c.log.find(e => e.id === eid);
    if (entry) { entry.text = text; entry.date = date; entry.type = document.getElementById('ml-type').value; }
  } else {
    c.log.push({ id: 'l' + uid(), date, type: document.getElementById('ml-type').value, text });
  }
  dbSave(); closeModal('log'); renderCaseProfile(cid);
}

function editLogEntry(caseId, logId) {
  const c = DB.cases.find(x => x.id == caseId); if (!c) return;
  const entry = (c.log || []).find(e => e.id === logId); if (!entry) return;
  document.getElementById('ml-title').textContent = 'âœï¸ ×¢×¨×™×›×ª ×¤×¢×•×œ×”';
  document.getElementById('ml-id').value = logId;
  document.getElementById('ml-caseid').value = caseId;
  document.getElementById('ml-date').value = entry.date;
  document.getElementById('ml-type').value = entry.type;
  document.getElementById('ml-text').value = entry.text;
  openModal('log');
}

function deleteLogEntry(caseId, logId) {
  if (!confirm('×œ××—×•×§ ×¤×¢×•×œ×” ×–×•?')) return;
  const c = DB.cases.find(x => x.id == caseId); if (!c) return;
  c.log = (c.log || []).filter(e => e.id !== logId);
  dbSave(); renderCaseProfile(caseId);
}

// â•â• HEARINGS â•â•
function openCaseHearingModal() {
  document.getElementById('mh-title').textContent = 'ğŸ› ×“×™×•×Ÿ ×—×“×©';
  document.getElementById('mh-id').value = '';
  document.getElementById('mh-caseid').value = activeCaseId;
  ['mh-title-inp','mh-time','mh-loc','mh-judge','mh-notes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('mh-date').value = '';
  document.getElementById('mh-add-cal').checked = false;
  document.getElementById('mh-del-btn').style.display = 'none';
  document.getElementById('modal-hearing').classList.add('open');
}

function duplicateHearing(hid) {
  const c = DB.cases.find(x => x.id == activeCaseId); if (!c) return;
  const h = (c.hearings || []).find(x => x.id === hid); if (!h) return;
  document.getElementById('mh-title').textContent = 'â§‰ ×©×›×¤×•×œ ×“×™×•×Ÿ';
  document.getElementById('mh-id').value = '';
  document.getElementById('mh-caseid').value = activeCaseId;
  document.getElementById('mh-title-inp').value = h.title;
  document.getElementById('mh-date').value = '';
  document.getElementById('mh-time').value = h.time || '';
  document.getElementById('mh-loc').value = h.loc || '';
  document.getElementById('mh-judge').value = h.judge || '';
  document.getElementById('mh-notes').value = h.notes || '';
  document.getElementById('mh-add-cal').checked = false;
  document.getElementById('mh-del-btn').style.display = 'none';
  openModal('hearing');
}

function editHearing(hid) {
  const c = DB.cases.find(x => x.id == activeCaseId); if (!c) return;
  const h = (c.hearings || []).find(x => x.id === hid); if (!h) return;
  document.getElementById('mh-title').textContent = 'âœï¸ ×¢×¨×™×›×ª ×“×™×•×Ÿ';
  document.getElementById('mh-id').value = hid;
  document.getElementById('mh-caseid').value = activeCaseId;
  document.getElementById('mh-title-inp').value = h.title;
  document.getElementById('mh-date').value = h.date;
  document.getElementById('mh-time').value = h.time || '';
  document.getElementById('mh-loc').value = h.loc || '';
  document.getElementById('mh-judge').value = h.judge || '';
  document.getElementById('mh-notes').value = h.notes || '';
  document.getElementById('mh-add-cal').checked = false;
  document.getElementById('mh-del-btn').style.display = 'inline-flex';
  document.getElementById('modal-hearing').classList.add('open');
}

function saveHearing() {
  const title = document.getElementById('mh-title-inp').value.trim();
  const date = document.getElementById('mh-date').value;
  if (!title || !date) { alert('×ª×™××•×¨ ×•×ª××¨×™×š ×—×•×‘×”'); return; }
  const cid = document.getElementById('mh-caseid').value;
  const c = DB.cases.find(x => x.id == cid); if (!c) return;
  if (!c.hearings) c.hearings = [];
  const eid = document.getElementById('mh-id').value;
  const obj = {
    id: eid || ('h' + uid()), title, date,
    time: document.getElementById('mh-time').value,
    loc: document.getElementById('mh-loc').value,
    judge: document.getElementById('mh-judge').value,
    notes: document.getElementById('mh-notes').value
  };
  if (eid) { const i = c.hearings.findIndex(h => h.id === eid); c.hearings[i] = obj; }
  else c.hearings.push(obj);
  // Add to calendar?
  if (document.getElementById('mh-add-cal').checked) {
    DB.events.push({ id: uid(), title: 'ğŸ› ' + title + ' â€” ' + c.name, date, time: obj.time, endTime: '', caseId: cid, loc: obj.loc, notes: obj.notes || '' });
  }
  dbSave(); closeModal('hearing'); renderCaseProfile(cid);
  // Ask about billing reminder
  if (confirm(`×”×× ×œ×”×•×¡×™×£ ××©×™××ª ×ª×–×›×•×¨×ª ×œ×¨×©×•× ×—×™×•×‘ ×¢×‘×•×¨ ×“×™×•×Ÿ ×–×”?\n\n"${title}"\n${fdate(date)}`)) {
    DB.tasks.push({
      id: uid(),
      title: `ğŸ’° ×œ×¨×©×•× ×—×™×•×‘ â€” ${title} (${fdate(date)})`,
      caseId: String(cid),
      prio: 'high',
      due: date,
      notes: `×ª×–×›×•×¨×ª ×œ×¨×©×•× ×—×™×•×‘ ×¢×‘×•×¨: ${title}`,
      done: false
    });
    dbSave(); updateBadge(); renderDashboard();
  }
}

function deleteHearing() { deleteHearingById(document.getElementById('mh-id').value); closeModal('hearing'); }
function deleteHearingById(hid) {
  if (!confirm('×œ××—×•×§ ×“×™×•×Ÿ ×–×”?')) return;
  const c = DB.cases.find(x => x.id == activeCaseId); if (!c) return;
  c.hearings = (c.hearings || []).filter(h => h.id !== hid);
  dbSave(); renderCaseProfile(activeCaseId);
}

// â•â• MEETINGS â•â•
function openCaseMeetingModal() {
  document.getElementById('mm-title').textContent = 'ğŸ¤ ×¤×’×™×©×” ×—×“×©×”';
  document.getElementById('mm-id').value = '';
  document.getElementById('mm-caseid').value = activeCaseId;
  ['mm-title-inp','mm-time','mm-endtime','mm-loc','mm-notes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('mm-date').value = '';
  document.getElementById('mm-add-cal').checked = false;
  document.getElementById('mm-del-btn').style.display = 'none';
  document.getElementById('modal-meeting').classList.add('open');
}

function editMeeting(mid) {
  const c = DB.cases.find(x => x.id == activeCaseId); if (!c) return;
  const m = (c.meetings || []).find(x => x.id === mid); if (!m) return;
  document.getElementById('mm-title').textContent = 'âœï¸ ×¢×¨×™×›×ª ×¤×’×™×©×”';
  document.getElementById('mm-id').value = mid;
  document.getElementById('mm-caseid').value = activeCaseId;
  document.getElementById('mm-title-inp').value = m.title;
  document.getElementById('mm-date').value = m.date;
  document.getElementById('mm-time').value = m.time || '';
  document.getElementById('mm-endtime').value = m.endTime || '';
  document.getElementById('mm-loc').value = m.loc || '';
  document.getElementById('mm-notes').value = m.notes || '';
  document.getElementById('mm-add-cal').checked = false;
  document.getElementById('mm-del-btn').style.display = 'inline-flex';
  document.getElementById('modal-meeting').classList.add('open');
}

function saveMeeting() {
  const title = document.getElementById('mm-title-inp').value.trim();
  const date = document.getElementById('mm-date').value;
  if (!title || !date) { alert('× ×•×©× ×•×ª××¨×™×š ×—×•×‘×”'); return; }
  const cid = document.getElementById('mm-caseid').value;
  const c = DB.cases.find(x => x.id == cid); if (!c) return;
  if (!c.meetings) c.meetings = [];
  const eid = document.getElementById('mm-id').value;
  const obj = {
    id: eid || ('m' + uid()), title, date,
    time: document.getElementById('mm-time').value,
    endTime: document.getElementById('mm-endtime').value,
    loc: document.getElementById('mm-loc').value,
    notes: document.getElementById('mm-notes').value
  };
  if (eid) { const i = c.meetings.findIndex(m => m.id === eid); c.meetings[i] = obj; }
  else c.meetings.push(obj);
  if (document.getElementById('mm-add-cal').checked) {
    DB.events.push({ id: uid(), title: 'ğŸ¤ ' + title + ' â€” ' + c.name, date, time: obj.time, endTime: obj.endTime, caseId: cid, loc: obj.loc, notes: obj.notes || '' });
  }
  dbSave(); closeModal('meeting'); renderCaseProfile(cid);
}

function deleteMeeting() { deleteMeetingById(document.getElementById('mm-id').value); closeModal('meeting'); }
function deleteMeetingById(mid) {
  if (!confirm('×œ××—×•×§ ×¤×’×™×©×” ×–×•?')) return;
  const c = DB.cases.find(x => x.id == activeCaseId); if (!c) return;
  c.meetings = (c.meetings || []).filter(m => m.id !== mid);
  dbSave(); renderCaseProfile(activeCaseId);
}

function openTaskForCase() {
  fillCaseSelect('mt-case');
  document.getElementById('mt-title').textContent = 'âœ… ××©×™××” ×—×“×©×”';
  document.getElementById('mt-id').value = '';
  ['mt-title-inp','mt-due','mt-notes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('mt-prio').value = 'med';
  document.getElementById('mt-case').value = activeCaseId;
  document.getElementById('modal-task').classList.add('open');
}

function openChargeForCase() {
  fillClientSelect('mch-client');
  fillCaseSelect('mch-case');
  fillChargeTemplateSelect();
  const cas = DB.cases.find(x => x.id == activeCaseId);
  document.getElementById('mch-title').textContent = 'ğŸ’° ×—×™×•×‘ ×—×“×©';
  document.getElementById('mch-id').value = '';
  ['mch-desc','mch-notes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('mch-amount').value = '';
  document.getElementById('mch-date').value = today();
  document.getElementById('mch-status').value = 'unpaid';
  document.getElementById('mch-template').value = '';
  const vp=document.getElementById('vat-preview');if(vp)vp.style.display='none';
  if (cas) { document.getElementById('mch-client').value = cas.clientId; onChargeClient(); document.getElementById('mch-case').value = activeCaseId; }
  document.getElementById('modal-charge').classList.add('open');
}

// â•â• CASE PROFILE â•â•
function saveCase(){
  const name=document.getElementById('mcs-name').value.trim();
  if(!name){alert('×©× ×”×ª×™×§ ×—×•×‘×”');return;}
  const cid=document.getElementById('mcs-client').value;
  if(!cid){alert('×™×© ×œ×‘×—×•×¨ ×œ×§×•×—');return;}
  const eid=document.getElementById('mcs-id').value;
  const obj={
    id:eid||uid(),name,
    num:document.getElementById('mcs-num').value,
    clientId:parseInt(cid),
    type:document.getElementById('mcs-type').value,
    subtype:document.getElementById('mcs-subtype')?.value||'',
    referrer:document.getElementById('mcs-referrer')?.value||'',
    status:document.getElementById('mcs-status').value,
    date:document.getElementById('mcs-date').value,
    closeDate:document.getElementById('mcs-close-date')?.value||'',
    extraId:document.getElementById('mcs-extra-id')?.value||'',
    court:document.getElementById('mcs-court').value,
    desc:document.getElementById('mcs-desc').value,
    updated:today()
  };
  if(eid){const i=DB.cases.findIndex(c=>c.id==eid);DB.cases[i]=obj;}
  else DB.cases.push(obj);
  dbSave();closeModal('case');
  if(currentView==='cases')renderCases();
  else if(currentView==='client-profile')renderProfile(profileClientId);
  renderDashboard();
}

function editCase(id){
  const c=DB.cases.find(x=>x.id==id);if(!c)return;
  fillClientSelect('mcs-client');
  document.getElementById('mcs-title').textContent='âœï¸ ×¢×¨×™×›×ª ×ª×™×§';
  document.getElementById('mcs-id').value=c.id;
  document.getElementById('mcs-name').value=c.name;
  document.getElementById('mcs-num').value=c.num||'';
  document.getElementById('mcs-client').value=c.clientId;
  document.getElementById('mcs-type').value=c.type;
  updateSubtypes();
  if(c.subtype)document.getElementById('mcs-subtype').value=c.subtype;
  document.getElementById('mcs-status').value=c.status;
  document.getElementById('mcs-date').value=c.date||'';
  document.getElementById('mcs-court').value=c.court||'';
  document.getElementById('mcs-desc').value=c.desc||'';
  document.getElementById('modal-case').classList.add('open');
}

function deleteCase(id){
  if(!confirm('×œ××—×•×§ ×ª×™×§ ×–×”?'))return;
  DB.cases=DB.cases.filter(c=>c.id!=id);
  dbSave();renderCases();renderDashboard();
}

function renderCases(){
  fillClientSelect('mcs-client');
  const filter=document.getElementById('cases-filter')?.value||'';
  let list=DB.cases;
  if(filter)list=list.filter(c=>c.status===filter);
  const tbody=document.getElementById('cases-tbody');
  if(!list.length){tbody.innerHTML='<tr><td colspan="7"><div class="empty"><div class="empty-icon">ğŸ“</div><div class="empty-text">××™×Ÿ ×ª×™×§×™×</div></div></td></tr>';return;}
  tbody.innerHTML=list.map(c=>`<tr>
    <td><strong>${c.num||'â€”'}</strong></td>
    <td><span class="case-row-link" onclick="openCaseProfile(${c.id})">${c.name}</span></td>
    <td>${clientName(c.clientId)}</td>
    <td>${c.type}${c.subtype?`<br><span style="font-size:11px;color:var(--text3)">${c.subtype}</span>`:''}</td>
    <td>${statusTag(c.status)}</td><td>${fdate(c.date)}</td>
    <td><div style="display:flex;gap:6px;">
      <button class="btn btn-ghost btn-xs" onclick="openCaseProfile(${c.id})">ğŸ“‚</button>
      <button class="btn btn-ghost btn-xs" onclick="editCase(${c.id})">âœï¸</button>
      <button class="btn btn-danger-soft btn-xs" onclick="deleteCase(${c.id})">ğŸ—‘</button>
    </div></td>
  </tr>`).join('');
}

// â•â• TASKS â•â•
function saveTask(){
  const title=document.getElementById('mt-title-inp').value.trim();
  if(!title){alert('×›×•×ª×¨×ª ×—×•×‘×”');return;}
  const eid=document.getElementById('mt-id').value;
  const obj={
    id:eid||uid(),title,
    caseId:document.getElementById('mt-case').value,
    prio:document.getElementById('mt-prio').value,
    due:document.getElementById('mt-due').value,
    notes:document.getElementById('mt-notes').value,
    done:false
  };
  if(eid){const i=DB.tasks.findIndex(t=>t.id==eid);obj.done=DB.tasks[i].done;DB.tasks[i]=obj;}
  else DB.tasks.push(obj);
  dbSave();closeModal('task');renderTasks();updateBadge();renderDashboard();
  if(currentView==='case-profile')renderCaseProfile(activeCaseId);
}

function toggleTask(id){
  const t=DB.tasks.find(x=>x.id==id);if(t)t.done=!t.done;
  dbSave();updateBadge();renderDashboard();
  if(currentView==='tasks')renderTasks();
  else if(currentView==='client-profile')renderProfile(profileClientId);
}

function editTask(id){
  const t=DB.tasks.find(x=>x.id==id);if(!t)return;
  fillCaseSelect('mt-case');
  document.getElementById('mt-title').textContent='âœï¸ ×¢×¨×™×›×ª ××©×™××”';
  document.getElementById('mt-id').value=t.id;
  document.getElementById('mt-title-inp').value=t.title;
  document.getElementById('mt-case').value=t.caseId||'';
  document.getElementById('mt-prio').value=t.prio;
  const mrEl=document.getElementById('mt-reminder');if(mrEl)mrEl.value=t.reminder||'';
  document.getElementById('mt-due').value=t.due||'';
  document.getElementById('mt-notes').value=t.notes||'';
  document.getElementById('modal-task').classList.add('open');
}

function deleteTask(id){
  if(!confirm('×œ××—×•×§?'))return;
  DB.tasks=DB.tasks.filter(t=>t.id!=id);
  dbSave();renderTasks();updateBadge();
}

function renderTasks(){
  const filter=document.getElementById('tasks-filter')?.value||'open';
  let list=DB.tasks;
  const td2=today();
  if(filter==='open')list=list.filter(t=>!t.done);
  if(filter==='done')list=list.filter(t=>t.done);
  if(filter==='reminder')list=list.filter(t=>!t.done&&t.reminder&&t.reminder<=td2);
  list=[...list].sort((a,b)=>{
    const pv={high:0,med:1,low:2};
    if(pv[a.prio]!==pv[b.prio])return pv[a.prio]-pv[b.prio];
    return(a.due||'').localeCompare(b.due||'');
  });
  const tbody=document.getElementById('tasks-tbody');
  if(!list.length){tbody.innerHTML='<tr><td colspan="6"><div class="empty"><div class="empty-icon">âœ…</div><div class="empty-text">××™×Ÿ ××©×™××•×ª</div></div></td></tr>';return;}
  tbody.innerHTML=list.map(t=>`<tr class="${t.done?'task-done':''}">
    <td><input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" style="cursor:pointer;accent-color:var(--accent2);width:15px;height:15px;"></td>
    <td><strong>${t.title}</strong>${t.notes?`<br><span style="font-size:11px;color:var(--text3)">${t.notes}</span>`:''}</td>
    <td>${t.caseId?caseName(t.caseId):'â€”'}</td>
    <td>${t.reminder?`<span style="color:${isOverdue(t.reminder)&&!t.done?'var(--danger)':'var(--text2)'}">${fdate(t.reminder)}</span>`:'â€”'}</td>
    <td>${t.due?`<span style="color:${isOverdue(t.due)&&!t.done?'var(--danger)':'inherit'}">${fdate(t.due)}</span>`:'â€”'}</td>
    <td>${prioLabel(t.prio)}</td>
    <td><div style="display:flex;gap:6px;">
      <button class="btn btn-ghost btn-xs" onclick="editTask(${t.id})">âœï¸</button>
      <button class="btn btn-danger-soft btn-xs" onclick="deleteTask(${t.id})">ğŸ—‘</button>
    </div></td>
  </tr>`).join('');
}

// â•â• EVENTS â•â•
function saveEvent(){
  const title=document.getElementById('mev-title-inp').value.trim();
  const date=document.getElementById('mev-date').value;
  if(!title||!date){alert('×›×•×ª×¨×ª ×•×ª××¨×™×š ×—×•×‘×”');return;}
  const eid=document.getElementById('mev-id').value;
  const obj={
    id:eid||uid(),title,date,
    time:document.getElementById('mev-time').value,
    endTime:document.getElementById('mev-endtime').value,
    caseId:document.getElementById('mev-case').value,
    loc:document.getElementById('mev-loc').value,
    notes:document.getElementById('mev-notes').value
  };
  if(eid){const i=DB.events.findIndex(e=>e.id==eid);DB.events[i]=obj;}
  else DB.events.push(obj);
  dbSave();closeModal('event');renderCalendar();renderDashboard();
}

let _editEventId=null;
function editEvent(id){
  const e=DB.events.find(x=>x.id==id);if(!e)return;
  _editEventId=id;
  fillCaseSelect('mev-case');
  document.getElementById('mev-title').textContent='âœï¸ ×¢×¨×™×›×ª ××™×¨×•×¢';
  document.getElementById('mev-id').value=e.id;
  document.getElementById('mev-title-inp').value=e.title;
  document.getElementById('mev-date').value=e.date;
  document.getElementById('mev-time').value=e.time||'';
  document.getElementById('mev-endtime').value=e.endTime||'';
  document.getElementById('mev-case').value=e.caseId||'';
  document.getElementById('mev-loc').value=e.loc||'';
  document.getElementById('mev-notes').value=e.notes||'';
  document.getElementById('mev-delete-btn').style.display='inline-flex';
  document.getElementById('modal-event').classList.add('open');
}

function deleteEventFromModal(){
  if(!confirm('×œ××—×•×§ ××™×¨×•×¢ ×–×”?'))return;
  DB.events=DB.events.filter(e=>e.id!=_editEventId);
  dbSave();closeModal('event');renderCalendar();renderDashboard();
}

const HM=['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
const HD=['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];

function renderCalendar(){
  document.getElementById('cal-label').textContent=`${HM[calM]} ${calY}`;
  const grid=document.getElementById('cal-grid');
  grid.innerHTML='';
  HD.forEach(d=>grid.innerHTML+=`<div class="cal-hdr">${d}</div>`);
  const first=new Date(calY,calM,1).getDay();
  const days=new Date(calY,calM+1,0).getDate();
  const td=today();
  for(let i=0;i<first;i++){
    const d=new Date(calY,calM,-first+i+1);
    grid.innerHTML+=`<div class="cal-day other"><div class="cal-daynum">${d.getDate()}</div></div>`;
  }
  for(let d=1;d<=days;d++){
    const ds=`${calY}-${String(calM+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const evs=DB.events.filter(e=>e.date===ds);
    const evHTML=evs.slice(0,3).map(e=>`<div class="cal-evt" onclick="event.stopPropagation();editEvent(${e.id})" title="${e.title}">${e.time?`<span dir="ltr">${e.time.substring(0,5)}</span> `:''} ${e.title}</div>`).join('');
    const more=evs.length>3?`<div style="font-size:10px;color:var(--text3)">+${evs.length-3}</div>`:'';
    grid.innerHTML+=`<div class="cal-day${ds===td?' today':''}" onclick="quickEvent('${ds}')">
      <div class="cal-daynum">${d}</div>${evHTML}${more}
    </div>`;
  }
}

function quickEvent(ds){
  fillCaseSelect('mev-case');
  document.getElementById('mev-title').textContent='ğŸ“… ××™×¨×•×¢ ×—×“×©';
  document.getElementById('mev-id').value='';
  ['mev-title-inp','mev-time','mev-endtime','mev-loc','mev-notes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('mev-date').value=ds;
  document.getElementById('mev-delete-btn').style.display='none';
  document.getElementById('modal-event').classList.add('open');
}

function calMove(dir){calM+=dir;if(calM<0){calM=11;calY--;}if(calM>11){calM=0;calY++;}renderCalendar();}

function exportICS(){
  if(!DB.events.length){alert('××™×Ÿ ××™×¨×•×¢×™× ×œ×™×™×¦×•×');return;}
  let ics='BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//LegalMgr//HE\r\nCALSCALE:GREGORIAN\r\n';
  DB.events.forEach(ev=>{
    const dt=ev.date.replace(/-/g,'');
    const allDay=!ev.time;
    const st=allDay?dt:dt+'T'+ev.time.replace(':','')+'00';
    const et=ev.endTime?(dt+'T'+ev.endTime.replace(':','')+'00'):st;
    ics+='BEGIN:VEVENT\r\n';
    ics+=`UID:lm-${ev.id}@legal\r\n`;
    ics+=allDay?`DTSTART;VALUE=DATE:${dt}\r\nDTEND;VALUE=DATE:${dt}\r\n`:`DTSTART:${st}\r\nDTEND:${et}\r\n`;
    ics+=`SUMMARY:${ev.title}\r\n`;
    if(ev.loc)ics+=`LOCATION:${ev.loc}\r\n`;
    if(ev.notes)ics+=`DESCRIPTION:${ev.notes.replace(/\n/g,'\\n')}\r\n`;
    ics+='END:VEVENT\r\n';
  });
  ics+='END:VCALENDAR';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([ics],{type:'text/calendar'}));
  a.download='legal-calendar.ics';a.click();
}

// â•â• CHARGES â•â•
function quickChargeStatus(id,status){
  const c=DB.charges.find(x=>x.id==id);if(c){c.status=status;dbSave();}
  renderCharges();renderDashboard();
  if(currentView==='client-profile')renderProfile(profileClientId);
}

function saveCharge(){
  const desc=document.getElementById('mch-desc').value.trim();
  const cid=document.getElementById('mch-client').value;
  const amt=parseFloat(document.getElementById('mch-amount').value);
  if(!desc||!cid||isNaN(amt)){alert('×ª×™××•×¨, ×œ×§×•×— ×•×¡×›×•× ×—×•×‘×”');return;}
  const eid=document.getElementById('mch-id').value;
  const obj={
    id:eid||uid(),desc,clientId:parseInt(cid),
    caseId:document.getElementById('mch-case').value,
    amount:amt,
    date:document.getElementById('mch-date').value,
    status:document.getElementById('mch-status').value,
    notes:document.getElementById('mch-notes').value
  };
  if(eid){const i=DB.charges.findIndex(c=>c.id==eid);DB.charges[i]=obj;}
  else DB.charges.push(obj);
  dbSave();closeModal('charge');renderCharges();renderDashboard();
  if(currentView==='client-profile')renderProfile(profileClientId);
  if(currentView==='case-profile')renderCaseProfile(activeCaseId);
}

function editCharge(id){
  const c=DB.charges.find(x=>x.id==id);if(!c)return;
  fillClientSelect('mch-client');
  fillChargeTemplateSelect();
  document.getElementById('mch-template').value='';
  document.getElementById('mch-title').textContent='âœï¸ ×¢×¨×™×›×ª ×—×™×•×‘';
  document.getElementById('mch-id').value=c.id;
  document.getElementById('mch-desc').value=c.desc;
  document.getElementById('mch-amount').value=c.amount;
  document.getElementById('mch-date').value=c.date||'';
  document.getElementById('mch-status').value=c.status;
  document.getElementById('mch-notes').value=c.notes||'';
  document.getElementById('mch-client').value=c.clientId;
  fillCaseSelect('mch-case', c.clientId);
  if(c.caseId) document.getElementById('mch-case').value=c.caseId;
  updateVatPreview();
  document.getElementById('modal-charge').classList.add('open');
}

function deleteCharge(id){
  if(!confirm('×œ××—×•×§?'))return;
  DB.charges=DB.charges.filter(c=>c.id!=id);
  dbSave();renderCharges();renderDashboard();
  if(activeCaseId)renderCaseProfile(DB.cases.find(x=>x.id==activeCaseId));
}

function duplicateCharge(id){
  const ch=DB.charges.find(x=>x.id==id);if(!ch)return;
  fillClientSelect('mch-client');
  fillCaseSelect('mch-case');
  fillChargeTemplateSelect();
  document.getElementById('mch-template').value='';
  document.getElementById('mch-title').textContent='â§‰ ×©×›×¤×•×œ ×—×™×•×‘';
  document.getElementById('mch-id').value='';
  document.getElementById('mch-desc').value=ch.desc;
  document.getElementById('mch-amount').value=ch.amount;
  document.getElementById('mch-date').value=today();
  document.getElementById('mch-status').value='unpaid';
  document.getElementById('mch-notes').value=ch.notes||'';
  // set client first, then refill cases for that client, then restore case
  document.getElementById('mch-client').value=ch.clientId;
  fillCaseSelect('mch-case', ch.clientId);
  if(ch.caseId) document.getElementById('mch-case').value=ch.caseId;
  updateVatPreview();
  document.getElementById('modal-charge').classList.add('open');
}

function onChargeClient(){
  const cid=document.getElementById('mch-client').value;
  fillCaseSelect('mch-case',cid);
}

function renderCharges(){
  const filter=document.getElementById('charges-filter')?.value||'';
  let list=DB.charges;
  if(filter)list=list.filter(c=>c.status===filter);
  list=[...list].sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  const unpaid=DB.charges.filter(c=>c.status!=='paid').reduce((s,c)=>s+c.amount,0);
  const paid=DB.charges.filter(c=>c.status==='paid').reduce((s,c)=>s+c.amount,0);
  document.getElementById('total-unpaid').textContent='â‚ª'+unpaid.toLocaleString();
  document.getElementById('total-paid').textContent='â‚ª'+paid.toLocaleString();
  const tbody=document.getElementById('charges-tbody');
  if(!list.length){tbody.innerHTML='<tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ’°</div><div class="empty-text">××™×Ÿ ×—×™×•×‘×™×</div></div></td></tr>';return;}
  tbody.innerHTML=list.map(c=>`<tr>
    <td>${c.desc}${c.notes?`<br><span style="font-size:11px;color:var(--text3)">${c.notes}</span>`:''}</td>
    <td>${clientName(c.clientId)}${c.caseId?`<br><span style="font-size:11px;color:var(--text3)">${caseName(c.caseId)}</span>`:''}</td>
    <td><span class="amount">â‚ª${Number(c.amount).toLocaleString()}</span></td>
    <td>${fdate(c.date)}</td>
    <td><select class="qs-select" onchange="quickChargeStatus(${c.id},this.value)">
      <option value="unpaid"${c.status==='unpaid'?' selected':''}>×œ× ×©×•×œ×</option>
      <option value="partial"${c.status==='partial'?' selected':''}>×—×œ×§×™</option>
      <option value="paid"${c.status==='paid'?' selected':''}>×©×•×œ×</option>
    </select></td>
    <td><div style="display:flex;gap:6px;">
      <button class="btn btn-ghost btn-xs" onclick="editCharge(${c.id})">âœï¸</button>
      <button class="btn btn-danger-soft btn-xs" onclick="deleteCharge(${c.id})">ğŸ—‘</button>
    </div></td>
  </tr>`).join('');
}

// â•â• DASHBOARD â•â•
function renderDashboard(){
  document.getElementById('s-clients').textContent=DB.clients.length;
  document.getElementById('s-cases').textContent=DB.cases.filter(c=>c.status!=='closed').length;
  document.getElementById('s-charges').textContent='â‚ª'+DB.charges.filter(c=>c.status!=='paid').reduce((s,c)=>s+c.amount,0).toLocaleString();
  const td=today();
  const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);const tmr=tomorrow.toISOString().split('T')[0];
  const allReminders=DB.tasks.filter(t=>!t.done&&t.reminder&&t.reminder<=tmr).sort((a,b)=>(a.reminder||'').localeCompare(b.reminder||''));
  const elSR=document.getElementById('s-reminders');if(elSR)elSR.textContent=allReminders.filter(t=>t.reminder<=td).length;
  // Reminders panel
  const dr=document.getElementById('dash-reminders');
  if(dr)dr.innerHTML=allReminders.length?allReminders.slice(0,6).map(t=>`<div style="display:flex;align-items:center;gap:9px;padding:8px 0;border-bottom:1px solid var(--border);">
    <input type="checkbox" onchange="toggleTask(${t.id})" style="accent-color:var(--accent2);width:14px;height:14px;cursor:pointer;">
    <div style="flex:1;"><div style="font-size:13px;font-weight:600;">${t.title}</div><div style="font-size:11px;color:${isOverdue(t.reminder)?'var(--danger)':'var(--text3)'};">${fdate(t.reminder)}${t.caseId?' Â· '+caseName(t.caseId):''}</div></div>
    ${prioLabel(t.prio)}
  </div>`).join(''):'<div style="color:var(--text3);font-size:13px;padding:14px 0;">××™×Ÿ ×ª×–×›×•×¨×•×ª ×œ×”×™×•× ğŸ‰</div>';
  // Events panel
  const upcoming=[...DB.events].filter(e=>e.date>=td).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,5);
  const de=document.getElementById('dash-events');
  if(de)de.innerHTML=upcoming.length?upcoming.map(e=>`<div style="display:flex;align-items:center;gap:11px;padding:8px 0;border-bottom:1px solid var(--border);">
    <div style="background:rgba(59,130,246,.15);border-radius:7px;padding:5px 9px;text-align:center;min-width:44px;">
      <div style="font-size:10px;color:var(--text3);">${['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'][parseInt(e.date.split('-')[1])-1]}</div>
      <div style="font-size:16px;font-weight:800;color:var(--accent2);">${parseInt(e.date.split('-')[2])}</div>
    </div>
    <div><div style="font-size:13px;font-weight:600;">${e.title}</div><div style="font-size:11px;color:var(--text3);">${e.time?`<span dir="ltr">${e.time.substring(0,5)}</span> Â· `:''}${e.loc||''}${e.caseId?' Â· '+caseName(e.caseId):''}</div></div>
  </div>`).join(''):'<div style="color:var(--text3);font-size:13px;padding:14px 0;">××™×Ÿ ××™×¨×•×¢×™× ×§×¨×•×‘×™×</div>';
  // Active tasks (secondary/smaller)
  const activeTasks=[...DB.tasks].filter(t=>!t.done).sort((a,b)=>{const pv={high:0,med:1,low:2};return pv[a.prio]-pv[b.prio];}).slice(0,5);
  const dt=document.getElementById('dash-tasks');
  if(dt)dt.innerHTML=activeTasks.length?activeTasks.map(t=>`<div style="display:flex;align-items:center;gap:7px;padding:5px 0;border-bottom:1px solid var(--border);">
    <input type="checkbox" onchange="toggleTask(${t.id})" style="accent-color:var(--accent2);width:13px;height:13px;cursor:pointer;">
    <div style="flex:1;">${t.title}</div>${prioLabel(t.prio)}
  </div>`).join(''):'<div style="color:var(--text3);padding:10px 0;">××™×Ÿ ××©×™××•×ª ×¤×¢×™×œ×•×ª ğŸ‰</div>';
  // Active cases (secondary/smaller)
  const activeCases=DB.cases.filter(c=>c.status!=='closed').slice(0,5);
  const dac=document.getElementById('dash-active-cases');
  if(dac)dac.innerHTML=activeCases.length?activeCases.map(c=>`<div style="display:flex;align-items:center;gap:7px;padding:5px 0;border-bottom:1px solid var(--border);">
    <span class="case-row-link" onclick="openCaseProfile(${c.id})">${c.name}</span>
    <span style="margin-right:auto;">${statusTag(c.status)}</span>
  </div>`).join(''):'<div style="color:var(--text3);padding:10px 0;">××™×Ÿ ×ª×™×§×™× ×¤×¢×™×œ×™×</div>';
}

function handleSearch(val){
  if(currentView!=='clients'&&currentView!=='cases')navTo('clients');
  renderClients(val||undefined);
}

// â•â• BACKUP â•â•
function openBackup(){document.getElementById('modal-backup').classList.add('open');}
function exportJSON(){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}));
  a.download=`legal-backup-${today()}.json`;a.click();
}
function triggerImport(){document.getElementById('import-file').click();}
function importData(ev){
  const f=ev.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      if(!confirm('×™×™×‘×•× ×™×—×œ×™×£ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™×. ×œ×”××©×™×š?'))return;
      DB=d;dbSave();
      renderDashboard();renderCalendar();updateBadge();
      alert('âœ… ×™×™×‘×•× ×”×•×©×œ×!');
    }catch(err){alert('×©×’×™××”: '+err.message);}
  };
  r.readAsText(f);ev.target.value='';
}

// â•â• GOOGLE DRIVE â•â•
// Replace with your own Client ID from console.cloud.google.com
const GDRIVE_CLIENT_ID='624619006871-vchmldvpff9em4v95b37fk56ijaniab1.apps.googleusercontent.com';
const GDRIVE_SCOPE='https://www.googleapis.com/auth/drive.file';
const GDRIVE_FNAME='legal-manager-backup.json';
let gdriveToken=null;
let gdriveFileId=localStorage.getItem('gd_fid')||null;

function gdriveStatus(msg,type){
  const el=document.getElementById('gdrive-status');
  el.textContent=msg;el.className=type;
}

function gdriveConnect(){
  if(GDRIVE_CLIENT_ID==='YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com'){
    gdriveStatus('âš ï¸ × × ×œ×”×’×“×™×¨ Google Client ID ×‘×§×•×“ (×¨××™ ×”×•×¨××•×ª ×‘×¤×× ×œ ×”×’×™×‘×•×™)','err');return;
  }
  gdriveStatus('××ª×—×‘×¨...','info');
  try{
    const client=google.accounts.oauth2.initTokenClient({
      client_id:GDRIVE_CLIENT_ID,scope:GDRIVE_SCOPE,
      callback:(resp)=>{
        if(resp.error){gdriveStatus('×©×’×™××”: '+resp.error,'err');return;}
        gdriveToken=resp.access_token;
        gdriveStatus('âœ… ××—×•×‘×¨! ×›×¢×ª ×ª×•×›×œ×™ ×œ×©××•×¨ ×•×œ×©×—×–×¨.','ok');
      }
    });
    client.requestAccessToken();
  }catch(e){gdriveStatus('×¡×¤×¨×™×™×ª Google ×œ× × ×˜×¢× ×”. ×‘×“×§×™ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.','err');}
}

async function gdriveSave(){
  if(!gdriveToken){gdriveStatus('×™×© ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×”','err');return;}
  gdriveStatus('×©×•××¨...','info');
  const content=JSON.stringify(DB,null,2);
  try{
    if(!gdriveFileId){
      const meta=await fetch('https://www.googleapis.com/drive/v3/files',{
        method:'POST',
        headers:{Authorization:`Bearer ${gdriveToken}`,'Content-Type':'application/json'},
        body:JSON.stringify({name:GDRIVE_FNAME,mimeType:'application/json'})
      }).then(r=>r.json());
      gdriveFileId=meta.id;localStorage.setItem('gd_fid',gdriveFileId);
    }
    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${gdriveFileId}?uploadType=media`,{
      method:'PATCH',
      headers:{Authorization:`Bearer ${gdriveToken}`,'Content-Type':'application/json'},
      body:content
    });
    gdriveStatus('âœ… × ×©××¨ ×‘-Google Drive! '+new Date().toLocaleTimeString('he-IL'),'ok');
  }catch(e){gdriveStatus('×©×’×™××ª ×©××™×¨×”: '+e.message,'err');}
}

async function gdriveLoad(){
  if(!gdriveToken){gdriveStatus('×™×© ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×”','err');return;}
  if(!gdriveFileId){gdriveStatus('×œ× × ××¦× ×§×•×‘×¥ ×’×™×‘×•×™ (×©××¨×™ ×§×•×“×)','err');return;}
  gdriveStatus('×˜×•×¢×Ÿ ××”×¢× ×Ÿ...','info');
  try{
    const r=await fetch(`https://www.googleapis.com/drive/v3/files/${gdriveFileId}?alt=media`,{
      headers:{Authorization:`Bearer ${gdriveToken}`}
    });
    const d=await r.json();
    if(!confirm('×©×—×–×•×¨ ×™×—×œ×™×£ ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™×. ×œ×”××©×™×š?'))return;
    DB=d;dbSave();
    renderDashboard();renderCalendar();updateBadge();
    gdriveStatus('âœ… ×©×•×—×–×¨ ×‘×”×¦×œ×—×”!','ok');
  }catch(e){gdriveStatus('×©×’×™××ª ×˜×¢×™× ×”: '+e.message,'err');}
}

// â•â• MISSING FUNCTIONS â•â•

function openNewClient(){
  document.getElementById('mc-title').textContent='ğŸ‘¤ ×œ×§×•×— ×—×“×©';
  document.getElementById('mc-id').value='';
  ['mc-firstname','mc-lastname','mc-idnum','mc-phone','mc-email','mc-addr','mc-notes'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.value='';
  });
  openModal('client');
}

function openNewCase(){
  fillClientSelect('mcs-client');
  fillCaseTypeSelect();
  fillReferrerSelect('mcs-referrer');
  document.getElementById('mcs-title').textContent='ğŸ“ ×ª×™×§ ×—×“×©';
  document.getElementById('mcs-id').value='';
  ['mcs-num','mcs-name','mcs-court','mcs-desc'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const cd=document.getElementById('mcs-close-date');if(cd)cd.value='';
  const ei=document.getElementById('mcs-extra-id');if(ei)ei.value='';
  document.getElementById('mcs-date').value=today();
  document.getElementById('mcs-status').value='active';
  const sr=document.getElementById('subtype-row');if(sr)sr.style.display='none';
  openModal('case');
}

function openNewTask(){
  fillCaseSelect('mt-case');
  document.getElementById('mt-title').textContent='âœ… ××©×™××” ×—×“×©×”';
  document.getElementById('mt-id').value='';
  ['mt-title-inp','mt-due','mt-notes'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const mr=document.getElementById('mt-reminder');if(mr)mr.value='';
  document.getElementById('mt-prio').value='med';
  openModal('task');
}

function openNewCharge(){
  fillClientSelect('mch-client');
  fillCaseSelect('mch-case');
  fillChargeTemplateSelect();
  document.getElementById('mch-title').textContent='ğŸ’° ×—×™×•×‘ ×—×“×©';
  document.getElementById('mch-id').value='';
  ['mch-desc','mch-notes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('mch-amount').value='';
  document.getElementById('mch-date').value=today();
  document.getElementById('mch-status').value='unpaid';
  const mt=document.getElementById('mch-template');if(mt)mt.value='';
  const vp=document.getElementById('vat-preview');if(vp)vp.style.display='none';
  openModal('charge');
}

function openNewEvent(){
  fillCaseSelect('mev-case');
  document.getElementById('mev-title').textContent='ğŸ“… ××™×¨×•×¢ ×—×“×©';
  document.getElementById('mev-id').value='';
  ['mev-title-inp','mev-time','mev-endtime','mev-loc','mev-notes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('mev-date').value='';
  document.getElementById('mev-delete-btn').style.display='none';
  openModal('event');
}

function renderReferrersList(){
  const el=document.getElementById('referrers-list');if(!el)return;
  el.innerHTML=(DB.referrers||[]).map((r,i)=>`<div style="display:flex;align-items:center;gap:7px;padding:7px 11px;border-bottom:1px solid var(--border);">
    <span style="flex:1;font-size:13px;">${r}</span>
    <button class="btn btn-danger-soft btn-xs" onclick="deleteReferrer(${i})">âœ•</button>
  </div>`).join('')||'<div style="padding:10px;color:var(--text3);font-size:12px;">××™×Ÿ ×’×•×¨××™ ×”×¤× ×™×”</div>';
}
function addReferrer(){
  const name=document.getElementById('new-referrer-inp').value.trim();if(!name)return;
  if(!DB.referrers)DB.referrers=[];
  DB.referrers.push(name);document.getElementById('new-referrer-inp').value='';
  dbSave();renderReferrersList();
}
function deleteReferrer(i){
  if(!confirm('×œ××—×•×§?'))return;
  DB.referrers.splice(i,1);dbSave();renderReferrersList();
}

function updateVatPreview(){
  const amt=parseFloat(document.getElementById('mch-amount').value);
  const el=document.getElementById('vat-preview');if(!el)return;
  if(isNaN(amt)||amt<=0){el.style.display='none';return;}
  el.style.display='block';
  el.innerHTML=`×›×•×œ×œ ××¢×´× (${DB.vatRate||18}%): <strong>â‚ª${withVat(amt).toLocaleString()}</strong>`;
}
function saveVatRate(){
  const v=parseFloat(document.getElementById('vat-rate-inp').value);
  if(isNaN(v)||v<0||v>100){alert('×©×™×¢×•×¨ ××¢×´× ×œ× ×ª×§×™×Ÿ');return;}
  DB.vatRate=v;dbSave();
  const vd=document.getElementById('vat-rate-display');if(vd)vd.textContent=`× ×•×›×—×™: ${v}%`;
  alert('×©×™×¢×•×¨ ×”××¢×´× ×¢×•×“×›×Ÿ ×œ-'+v+'%');
}

function openExportTasksModal(){
  const sel=document.getElementById('exp-client');
  if(sel){sel.innerHTML='<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>';DB.clients.forEach(c=>sel.innerHTML+=`<option value="${c.id}">${c.name}</option>`);}
  const csel=document.getElementById('exp-case');
  if(csel){csel.innerHTML='<option value="">×›×œ ×”×ª×™×§×™×</option>';DB.cases.forEach(c=>csel.innerHTML+=`<option value="${c.id}">${c.name}</option>`);}
  ['exp-reminder-from','exp-reminder-to','exp-due-from','exp-due-to'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const es=document.getElementById('exp-status');if(es)es.value='open';
  openModal('export-tasks');
}
function exportTasksCSV(){
  const clientId=document.getElementById('exp-client')?.value||'';
  const caseId=document.getElementById('exp-case')?.value||'';
  const rFrom=document.getElementById('exp-reminder-from')?.value||'';
  const rTo=document.getElementById('exp-reminder-to')?.value||'';
  const dFrom=document.getElementById('exp-due-from')?.value||'';
  const dTo=document.getElementById('exp-due-to')?.value||'';
  const status=document.getElementById('exp-status')?.value||'open';
  let list=[...DB.tasks];
  if(status==='open')list=list.filter(t=>!t.done);
  if(status==='done')list=list.filter(t=>t.done);
  if(clientId){const ids=DB.cases.filter(c=>c.clientId==clientId).map(c=>String(c.id));list=list.filter(t=>ids.includes(String(t.caseId)));}
  if(caseId)list=list.filter(t=>String(t.caseId)===String(caseId));
  if(rFrom)list=list.filter(t=>t.reminder&&t.reminder>=rFrom);
  if(rTo)list=list.filter(t=>t.reminder&&t.reminder<=rTo);
  if(dFrom)list=list.filter(t=>t.due&&t.due>=dFrom);
  if(dTo)list=list.filter(t=>t.due&&t.due<=dTo);
  if(!list.length){alert('×œ× × ××¦××• ××©×™××•×ª ×œ×™×™×¦×•×');return;}
  const lines=['"××©×™××”","×ª×™×§","×ª××¨×™×š ×ª×–×›×•×¨×ª","×ª××¨×™×š ××—×¨×•×Ÿ ×œ×‘×™×¦×•×¢","×¢×“×™×¤×•×ª","×¡×˜×˜×•×¡"'];
  list.forEach(t=>lines.push(`"${t.title}","${t.caseId?caseName(t.caseId):''}","${fdate(t.reminder)}","${fdate(t.due)}","${t.prio==='high'?'×’×‘×•×”×”':t.prio==='med'?'×‘×™× ×•× ×™×ª':'× ××•×›×”'}","${t.done?'×”×•×©×œ××”':'×¤×ª×•×—×”'}"`));
  const blob=new Blob(['\uFEFF'+lines.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`××©×™××•×ª-${today()}.csv`;a.click();
  closeModal('export-tasks');
}

function initSearch(){
  const sel=document.getElementById('adv-client');if(!sel)return;
  sel.innerHTML='<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>';
  DB.clients.forEach(c=>sel.innerHTML+=`<option value="${c.id}">${c.name}</option>`);
}
function runAdvSearch(){
  const text=(document.getElementById('adv-text')?.value||'').toLowerCase().trim();
  const type=document.getElementById('adv-type')?.value||'';
  const clientId=document.getElementById('adv-client')?.value||'';
  const status=document.getElementById('adv-status')?.value||'';
  const from=document.getElementById('adv-from')?.value||'';
  const to=document.getElementById('adv-to')?.value||'';
  const results=[];
  if(!type||type==='client')
    DB.clients.filter(c=>!text||c.name.toLowerCase().includes(text)||(c.phone||'').includes(text)||(c.email||'').toLowerCase().includes(text))
    .forEach(c=>results.push({type:'×œ×§×•×—',title:c.name,sub:c.phone||c.email||'',onclick:`openProfile(${c.id})`}));
  if(!type||type==='case')
    DB.cases.filter(c=>(!text||(c.name.toLowerCase().includes(text)||(c.num||'').includes(text)||(c.desc||'').toLowerCase().includes(text)))&&(!clientId||c.clientId==clientId)&&(!status||c.status===status)&&(!from||c.date>=from)&&(!to||c.date<=to))
    .forEach(c=>results.push({type:'×ª×™×§',title:c.name,sub:clientName(c.clientId)+' Â· '+c.type,onclick:`openCaseProfile(${c.id})`}));
  if(!type||type==='task')
    DB.tasks.filter(t=>!text||t.title.toLowerCase().includes(text)||(t.notes||'').toLowerCase().includes(text))
    .forEach(t=>results.push({type:'××©×™××”',title:t.title,sub:(t.caseId?caseName(t.caseId)+' Â· ':'')+(t.due?fdate(t.due):''),onclick:`editTask(${t.id})`}));
  if(!type||type==='charge')
    DB.charges.filter(ch=>!text||ch.desc.toLowerCase().includes(ch))
    .forEach(ch=>results.push({type:'×—×™×•×‘',title:ch.desc,sub:clientName(ch.clientId)+' Â· â‚ª'+Number(ch.amount).toLocaleString(),onclick:`editCharge(${ch.id})`}));
  const el=document.getElementById('adv-results');if(!el)return;
  if(!results.length){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-text">×œ× × ××¦××• ×ª×•×¦××•×ª</div></div>';return;}
  el.innerHTML=`<div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;">${results.map(r=>`<div class="search-result-item" onclick="${r.onclick}"><span class="sri-type">${r.type}</span><div><div class="sri-title">${r.title}</div><div class="sri-sub">${r.sub}</div></div></div>`).join('')}</div>`;
}


dbLoad();
if (!DB.caseTypes) {
  DB.caseTypes = [
    { name: '××–×¨×—×™', subtypes: [] },
    { name: '×¤×œ×™×œ×™', subtypes: ['×¢×‘×™×¨×•×ª × ×’×“ ×”×’×•×£', '×¢×‘×™×¨×•×ª ×¨×›×•×©', '×¢×‘×™×¨×•×ª ××™×Ÿ', '×¢×‘×™×¨×•×ª ×¡××™×', '×¢×‘×™×¨×•×ª ×ª×¢×‘×•×¨×”', '×¢×‘×™×¨×•×ª ×¦×•×•××¨×•×Ÿ ×œ×‘×Ÿ', '×¢×‘×™×¨×•×ª ××œ×™××•×ª ×‘××©×¤×—×”'] },
    { name: '××¡×—×¨×™', subtypes: [] },
    { name: '××©×¤×—×”', subtypes: ['×’×™×¨×•×©×™×Ÿ', '××©××•×¨×ª', '××–×•× ×•×ª', '×”×¡×›× ×××•×Ÿ', '×™×¨×•×©×”'] },
    { name: '×¢×‘×•×“×”', subtypes: [] },
    { name: '××§×¨×§×¢×™×Ÿ', subtypes: [] },
    { name: '×× ×”×œ×™', subtypes: [] },
    { name: '××—×¨', subtypes: [] }
  ];
}
if(!DB.referrers)DB.referrers=["×¡× ×™×’×•×¨×™×” ×¦×™×‘×•×¨×™×ª ×¨×’×™×œ","×¡× ×™×’×•×¨×™×” ×¦×™×‘×•×¨×™×ª ×¨×™×˜×™×™× ×¨","×¤×¨×˜×™"];
if(!DB.vatRate)DB.vatRate=18;
if (!DB.chargeTemplates) {
  DB.chargeTemplates = [
    { id: 'ct1',  name: '×©×œ×•× â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘××¢×¦×¨ ×™××™×', price: 766 },
    { id: 'ct2',  name: '×©×œ×•× â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘××¢×¦×¨ ×¢×“ ×ª×•× ×”×œ×™×›×™×', price: 918 },
    { id: 'ct3',  name: '×©×œ×•× â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×¢×‘×™×¨×ª ×—×˜×', price: 1072 },
    { id: 'ct4',  name: '×©×œ×•× â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×¢×‘×™×¨×” ×©×œ 5 ×©× ×™× ×•××¢×œ×”', price: 3150 },
    { id: 'ct5',  name: '×©×œ×•× â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×¢×‘×™×¨×” ×©×œ 3 ×©× ×™× ×•××¢×œ×”', price: 1839 },
    { id: 'ct6',  name: '×©×œ×•× â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×¢×‘×™×¨×” ××—×¨×ª', price: 1379 },
    { id: 'ct7',  name: '×©×œ×•× â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×¢×‘×™×¨×” ×©×œ ×’×¨×™××ª ××•×•×ª', price: 2831 },
    { id: 'ct8',  name: '×©×œ×•× â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×”×œ×™×š ×¢×™×§×¨×™ ××—×¨', price: 1922 },
    { id: 'ct9',  name: '×©×œ×•× â€“ ×™×©×™×‘×” × ×•×¡×¤×ª ××”×•×ª×™×ª', price: 584 },
    { id: 'ct10', name: '×©×œ×•× â€“ ×™×©×™×‘×” × ×•×¡×¤×ª ×œ× ××”×•×ª×™×ª', price: 394 },
    { id: 'ct11', name: '××—×•×–×™ â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×¢×¨×¨ ×¢×œ ××¢×¦×¨', price: 1145 },
    { id: 'ct12', name: '××—×•×–×™ â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘××¢×¦×¨ ×¢×“ ×ª×•× ×”×œ×™×›×™×', price: 1911 },
    { id: 'ct13', name: '××—×•×–×™ â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘××©×¤×˜ ×¤×œ×™×œ×™', price: 3828 },
    { id: 'ct14', name: '××—×•×–×™ â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×¢×¨×¢×•×¨ ×¤×œ×™×œ×™ ×¢×œ ×¤×¡×´×“', price: 3538 },
    { id: 'ct15', name: '××—×•×–×™ â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×¢×¨×¢×•×¨ ×¤×œ×™×œ×™ ×¢×œ ×’×–×´×“', price: 1770 },
    { id: 'ct16', name: '××—×•×–×™ â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×”×œ×™×š ×¢×™×§×¨×™ ××—×¨', price: 2520 },
    { id: 'ct17', name: '××—×•×–×™ â€“ ×™×©×™×‘×” × ×•×¡×¤×ª', price: 960 },
    { id: 'ct18', name: '×¢×œ×™×•×Ÿ â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×¢×¨×¨ ×¢×œ ××¢×¦×¨', price: 1911 },
    { id: 'ct19', name: '×¢×œ×™×•×Ÿ â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×¢×¨×¢×•×¨ ×¤×œ×™×œ×™ ×¢×œ ×¤×¡×´×“', price: 5308 },
    { id: 'ct20', name: '×¢×œ×™×•×Ÿ â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×¢×¨×¢×•×¨ ×¤×œ×™×œ×™ ×¢×œ ×’×–×´×“', price: 2652 },
    { id: 'ct21', name: '×¢×œ×™×•×Ÿ â€“ ×™×©×™×‘×” ×¨××©×•× ×” ×‘×”×œ×™×š ×¢×™×§×¨×™ ××—×¨', price: 2836 },
    { id: 'ct22', name: '×¢×œ×™×•×Ÿ â€“ ×™×©×™×‘×” × ×•×¡×¤×ª', price: 1530 },
    { id: 'ct23', name: '×©×¢×ª ×ª×•×¨× ×•×ª ×‘×‘×™×ª ××©×¤×˜', price: 185 },
    { id: 'ct24', name: '×©×¢×ª ×ª×•×¨× ×•×ª ××—×•×¥ ×œ×‘×™×ª ××©×¤×˜', price: 68 },
    { id: 'ct25', name: '×‘×™×§×•×¨ ×¨××©×•×Ÿ ××¦×œ ×—×©×•×“ ×‘××¢×¦×¨', price: 291 },
    { id: 'ct26', name: '×©×¢×ª ×‘×™×§×•×¨ ×‘×‘×™×ª ××¢×¦×¨ ××• ××©×¤×•×–', price: 121 },
    { id: 'ct27', name: '×©×¢×ª × ×¡×™×¢×” ×œ×‘×™×§×•×¨', price: 78 },
    { id: 'ct28', name: '×”×•×¦××•×ª × ×¡×™×¢×” (×œ×§×´×)', price: 1.4 }
  ];
}

let settingsSelectedType = null;

// â•â• SETTINGS â•â•
function openModal_settings() {
  renderTypesList();
  renderChargeTemplatesList();
  renderReferrersList();
  fillCaseTypeSelect();
  const vr=document.getElementById('vat-rate-inp');if(vr)vr.value=DB.vatRate||18;
  const vd=document.getElementById('vat-rate-display');if(vd)vd.textContent=`× ×•×›×—×™: ${DB.vatRate||18}%`;
  document.getElementById('modal-settings').classList.add('open');
}

function renderTypesList() {
  const el = document.getElementById('types-list');
  if (!DB.caseTypes.length) { el.innerHTML = '<div style="padding:12px;color:var(--text3);font-size:13px;">××™×Ÿ ×¡×•×’×™×</div>'; return; }
  el.innerHTML = DB.caseTypes.map((t, i) => `
    <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid var(--border);cursor:pointer;background:${settingsSelectedType===i?'rgba(201,168,76,.08)':'transparent'}" onclick="selectTypeForSubtypes(${i})">
      <span style="flex:1;font-size:13px;font-weight:${settingsSelectedType===i?700:400};color:${settingsSelectedType===i?'var(--accent)':'var(--text)'};">${t.name}</span>
      <span style="font-size:11px;color:var(--text3);">${t.subtypes.length} ×ª×ª-×¡×•×’×™×</span>
      <button class="btn btn-danger-soft btn-xs" onclick="event.stopPropagation();deleteCaseType(${i})">âœ•</button>
    </div>`).join('');
}

function selectTypeForSubtypes(i) {
  settingsSelectedType = i;
  document.getElementById('selected-type-label').textContent = DB.caseTypes[i].name;
  renderTypesList();
  renderSubtypesList();
}

function renderSubtypesList() {
  const el = document.getElementById('subtypes-list');
  if (settingsSelectedType === null) { el.innerHTML = '<div style="padding:12px;color:var(--text3);font-size:13px;">×‘×—×¨×™ ×¡×•×’ ×¨××©×™</div>'; return; }
  const t = DB.caseTypes[settingsSelectedType];
  if (!t.subtypes.length) { el.innerHTML = '<div style="padding:12px;color:var(--text3);font-size:13px;">××™×Ÿ ×ª×ª-×¡×•×’×™× â€” ×”×•×¡×™×¤×™ ×œ××˜×”</div>'; return; }
  el.innerHTML = t.subtypes.map((s, j) => `
    <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid var(--border);">
      <span style="flex:1;font-size:13px;">${s}</span>
      <button class="btn btn-danger-soft btn-xs" onclick="deleteSubtype(${j})">âœ•</button>
    </div>`).join('');
}

function addCaseType() {
  const name = document.getElementById('new-type-inp').value.trim();
  if (!name) return;
  DB.caseTypes.push({ name, subtypes: [] });
  document.getElementById('new-type-inp').value = '';
  dbSave(); renderTypesList(); fillCaseTypeSelect();
}

function deleteCaseType(i) {
  if (!confirm('×œ××—×•×§ ×¡×•×’ ×–×”?')) return;
  DB.caseTypes.splice(i, 1);
  if (settingsSelectedType === i) settingsSelectedType = null;
  dbSave(); renderTypesList(); renderSubtypesList(); fillCaseTypeSelect();
}

function addSubtype() {
  if (settingsSelectedType === null) { alert('×‘×—×¨×™ ×§×•×“× ×¡×•×’ ×¨××©×™'); return; }
  const name = document.getElementById('new-subtype-inp').value.trim();
  if (!name) return;
  DB.caseTypes[settingsSelectedType].subtypes.push(name);
  document.getElementById('new-subtype-inp').value = '';
  dbSave(); renderSubtypesList(); renderTypesList(); fillCaseTypeSelect();
}

function deleteSubtype(j) {
  if (settingsSelectedType === null) return;
  DB.caseTypes[settingsSelectedType].subtypes.splice(j, 1);
  dbSave(); renderSubtypesList(); renderTypesList(); fillCaseTypeSelect();
}

function fillCaseTypeSelect() {
  const sel = document.getElementById('mcs-type');
  if (!sel) return;
  const prev = sel.value;
  sel.innerHTML = '';
  (DB.caseTypes || []).forEach(t => {
    sel.innerHTML += `<option value="${t.name}">${t.name}</option>`;
  });
  if (prev) sel.value = prev;
  updateSubtypes();
}

function updateSubtypes() {
  const typeName = document.getElementById('mcs-type')?.value;
  const t = (DB.caseTypes || []).find(x => x.name === typeName);
  const row = document.getElementById('subtype-row');
  const sel = document.getElementById('mcs-subtype');
  if (!t || !t.subtypes.length) { if(row) row.style.display = 'none'; return; }
  if(row) row.style.display = '';
  sel.innerHTML = '<option value="">â€” ×‘×—×¨×™ ×ª×ª-×¡×•×’ â€”</option>';
  t.subtypes.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
}

// â•â• CHARGE TEMPLATES â•â•
function renderChargeTemplatesList() {
  const el = document.getElementById('charge-templates-list');
  if (!DB.chargeTemplates.length) { el.innerHTML = '<div style="padding:12px;color:var(--text3);font-size:13px;">××™×Ÿ ×¤×¨×™×˜×™× ×‘××—×™×¨×•×Ÿ</div>'; return; }
  el.innerHTML = DB.chargeTemplates.map(t => `
    <div style="display:grid;grid-template-columns:1fr 110px auto;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border);">
      <span style="font-size:13px;">${t.name}</span>
      <input type="number" value="${t.price}" min="0"
        style="padding:5px 8px;font-size:12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);text-align:left;"
        onchange="updateTemplatePrice('${t.id}', this.value)"
        placeholder="××—×™×¨">
      <button class="btn btn-danger-soft btn-xs" onclick="deleteChargeTemplate('${t.id}')">âœ•</button>
    </div>`).join('');
}

function addChargeTemplate() {
  const name = document.getElementById('new-tmpl-name').value.trim();
  const price = parseFloat(document.getElementById('new-tmpl-price').value) || 0;
  if (!name) return;
  DB.chargeTemplates.push({ id: 'ct' + uid(), name, price });
  document.getElementById('new-tmpl-name').value = '';
  document.getElementById('new-tmpl-price').value = '';
  dbSave(); renderChargeTemplatesList(); fillChargeTemplateSelect();
}

function updateTemplatePrice(id, val) {
  const t = DB.chargeTemplates.find(x => x.id === id);
  if (t) { t.price = parseFloat(val) || 0; dbSave(); fillChargeTemplateSelect(); }
}

function deleteChargeTemplate(id) {
  DB.chargeTemplates = DB.chargeTemplates.filter(t => t.id !== id);
  dbSave(); renderChargeTemplatesList(); fillChargeTemplateSelect();
}

function fillChargeTemplateSelect() {
  const sel = document.getElementById('mch-template');
  if (!sel) return;
  sel.innerHTML = '<option value="">â€” ×‘×—×™×¨×” ××”××—×™×¨×•×Ÿ (××•×¤×¦×™×•× ×œ×™) â€”</option>';
  (DB.chargeTemplates || []).forEach(t => {
    sel.innerHTML += `<option value="${t.id}">${t.name}${t.price ? ' â€” â‚ª' + t.price.toLocaleString() : ''}</option>`;
  });
}

function applyChargeTemplate() {
  const id = document.getElementById('mch-template').value;
  if (!id) return;
  const t = DB.chargeTemplates.find(x => x.id === id);
  if (!t) return;
  document.getElementById('mch-desc').value = t.name;
  if (t.price) {
    document.getElementById('mch-amount').value = t.price;
    updateVatPreview();
  }
}


renderDashboard();
renderCalendar();
updateBadge();
</script>
</body>
</html>
